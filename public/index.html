<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>CareerFlow - Professional Application Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAIQSURBVEhL7ZRLSwNBEIb/RCyIWEREEAQfElAREfFNEf+CAmJBiIgIIgiCIIgISyAiiSAgCOJ/AsElHyAie6e3s7OOKzV5EFy4qeqq6Z6e3tkdMMZ/zF+bOPk+kE3G8ryJ2F+9s5wfJ9a0lAA4wA1m6jAD45l6gKkPAzYAG8Mg1uKAXwA9sUuO5YqD2Fm2VCDA1V4C1sUan4gWw4FG2ZgA7Iq7f/41Yl4k2gVzPoclhO/kO4l2AzsW4p2pY3jS2w2PcPqA7dI1h4aLwGnwhk1nCg8I+pLiXGfAB43V1BfAk41XlBfD5rmoLsDKerDQmYlAMMRd2cAi3wBf/gXo2/kNmGisfsNwz4E2eDYOtl2fXQ1W7bI0j4Q0YyA2zCLwA8+lsuGSx1t1wZ/gTqfIN2Nl2eXwA+BGn8jYnlYB5xSg/T+E2b/43ge3bAsws7oBCpUn885wc13aY5k2g8T2YIny2kQ2QG0h1hA9Uxx8gK0n6L1u9NBzcjxijrgrwY8Y5wVe1n4C52g1gNOzQkTsSHq5z4jPMR4NnTPpIGu+17L44wLgAbY5vAJ5E3851G7j8sgaMPg2gSg2gSg2gSg3gC4p7wAjw+q5qC/Ak41XlBfD5rmoLsDKerDQmYlAMMRd2cAi3wBf/gXo2/kNmGisfsNwzYJPwXg3sZDcGSx1t1wZ/gTqfIN2Nl2eXwA+BGn8jYn1YBy4+UJT/sAxz+MKL/xrFvG3hA/j9AdB7Xl2uVwJb/KEbEyHagxQXs2OC1QE0yDEr9wqun2eZBtC430GvNOLe8l8gvgt9pA9Uxx8gK0n6L1u9NBzcjxijrgrwY8Y5wVe1n4C52g1gNOzQkTsSHq5z4jPMR4NnTPpIGu+17L44wLgAbY5vAJ5E3851G7j8sgaMPg2gSg2gSg2gSg3gC4p7wAjw+q5qC/Ak41XlBfD5rmoLsDKerDQmYlAMMRd2cAi3wBf/gXo2/kNmGisfsNwzYJPwXg3sZDcGSx1t1wZ/gTqfIN2Nl2eXwA+BGn8jYn1YBy4+UJT/sAxz+MKL/xolx2uM3wJj/PPgfzRI0VnBAi10AAAAASUVORK5CYII=">
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.11.1/dist/full.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="./firebase.js"></script>
  
  <script>
    // Initialize feather icons after loading
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof feather !== 'undefined') {
        feather.replace();
      }
    });
  </script>
</head>
<body class="bg-base-200 min-h-screen font-sans">
  
  <main id="root" class="container mx-auto p-4 md:p-6"></main>
  <div id="toast-container" class="toast toast-bottom toast-end z-50"></div>

  <script type="text/babel">
    /********* Injected data & Config *********/
    const statusList = ["Wishlist", "To Apply", "Applied", "HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview", "Offer Received", "Offer Accepted", "Rejected", "Withdrawn"];
    const jobTypeList = ["Internship", "Full-Time", "Part-Time", "Thesis Project"];
    const sourceList  = ["Polimi CareerService", "LinkedIn", "Company Website", "Referral", "Networking Event", "Other"];
    const DOUGHNUT_COLORS = { Offers: '#22C55E', Rejected: '#EF4444', 'In-Progress': '#F59E0B', Other: '#8B5CF6' };

    // Email Templates
    const emailTemplates = {
      followUp: {
        subject: "Following up on my application - [Position Title] at [Company Name]",
        body: `Dear Hiring Manager,

I hope this email finds you well. I wanted to follow up on my application for the [Position Title] position at [Company Name] that I submitted on [Application Date].

I remain very interested in this opportunity and would welcome the chance to discuss how my skills and experience align with your team's needs.

Please let me know if you need any additional information from me. I look forward to hearing from you.

Best regards,
[Your Name]`
      },
      thankYou: {
        subject: "Thank you for the interview - [Position Title]",
        body: `Dear [Interviewer Name],

Thank you for taking the time to meet with me yesterday to discuss the [Position Title] role at [Company Name]. I enjoyed our conversation about [specific topic discussed].

Our discussion reinforced my enthusiasm for this position and confirmed that my background in [relevant experience] would be valuable to your team.

Please don't hesitate to contact me if you need any additional information. I look forward to the next steps in the process.

Best regards,
[Your Name]`
      },
      networking: {
        subject: "Introduction and career advice request",
        body: `Dear [Contact Name],

I hope this message finds you well. I'm a [your current status] at [your institution/company] with a strong interest in [relevant field/industry].

I came across your profile and was impressed by your experience at [their company]. I would greatly appreciate the opportunity to learn more about your career journey and gain insights into the industry.

Would you be open to a brief 15-20 minute coffee chat or phone call in the coming weeks? I'm happy to work around your schedule.

Thank you for considering my request.

Best regards,
[Your Name]`
      }
    };

    const getTodayPlusDays = (days) => new Date(new Date().setDate(new Date().getDate() + days)).toISOString().split('T')[0];
    const getRecentDate = (daysAgo) => new Date(new Date().setDate(new Date().getDate() - daysAgo)).toISOString().split('T')[0];
    
    const sampleJobs  = [
      // Tech Companies
      { id: "job-1", Status: "Technical Interview", Company: "Google", Title: "Software Engineer Intern", JobType: "Internship", Location: "Mountain View, CA", Source: "Company Website", AppDeadline: getTodayPlusDays(5), DateApplied: getRecentDate(3), NextStep: "Coding interview scheduled for Friday" },
      { id: "job-2", Status: "Offer Received", Company: "Microsoft", Title: "Product Manager", JobType: "Full-Time", Location: "Seattle, WA", Source: "LinkedIn", AppDeadline: getTodayPlusDays(15), DateApplied: getRecentDate(18), NextStep: "Negotiating salary and start date" },
      { id: "job-3", Status: "Applied", Company: "Meta", Title: "Data Scientist", JobType: "Full-Time", Location: "Menlo Park, CA", Source: "Referral", AppDeadline: getTodayPlusDays(8), DateApplied: getRecentDate(2), NextStep: "Waiting for initial screening call" },
      { id: "job-4", Status: "HR Screening", Company: "Apple", Title: "iOS Developer", JobType: "Full-Time", Location: "Cupertino, CA", Source: "Company Website", AppDeadline: getTodayPlusDays(12), DateApplied: getRecentDate(9), NextStep: "Technical phone screen next week" },
      { id: "job-5", Status: "Rejected", Company: "Netflix", Title: "Machine Learning Engineer", JobType: "Full-Time", Location: "Los Gatos, CA", Source: "LinkedIn", AppDeadline: getRecentDate(60), DateApplied: getRecentDate(65), NextStep: "Rejected after final round - too junior" },
      
      // Consulting
      { id: "job-6", Status: "Case Study / Assessment", Company: "McKinsey & Company", Title: "Business Analyst", JobType: "Full-Time", Location: "New York, NY", Source: "Polimi CareerService", AppDeadline: getTodayPlusDays(3), DateApplied: getRecentDate(22), NextStep: "Final case interview on Monday" },
      { id: "job-7", Status: "Final Interview", Company: "Boston Consulting Group", Title: "Associate Consultant", JobType: "Full-Time", Location: "Chicago, IL", Source: "Networking Event", AppDeadline: getTodayPlusDays(7), DateApplied: getRecentDate(19), NextStep: "Partner interview scheduled" },
      { id: "job-8", Status: "Applied", Company: "Bain & Company", Title: "Summer Associate", JobType: "Internship", Location: "London, UK", Source: "Company Website", AppDeadline: getTodayPlusDays(20), DateApplied: getRecentDate(4), NextStep: "Application under review" },
      { id: "job-9", Status: "Offer Accepted", Company: "Deloitte", Title: "Technology Consultant", JobType: "Full-Time", Location: "Milan, Italy", Source: "Polimi CareerService", AppDeadline: getRecentDate(90), DateApplied: getRecentDate(95), NextStep: "Starting March 1st, 2025" },
      
      // Finance
      { id: "job-10", Status: "HR Screening", Company: "Goldman Sachs", Title: "Investment Banking Analyst", JobType: "Full-Time", Location: "New York, NY", Source: "Company Website", AppDeadline: getTodayPlusDays(25), DateApplied: getRecentDate(15), NextStep: "Superday invitation pending" },
      { id: "job-11", Status: "Technical Interview", Company: "JPMorgan Chase", Title: "Quantitative Analyst", JobType: "Full-Time", Location: "London, UK", Source: "LinkedIn", AppDeadline: getTodayPlusDays(18), DateApplied: getRecentDate(7), NextStep: "Technical modeling test this week" },
      { id: "job-12", Status: "Rejected", Company: "Morgan Stanley", Title: "Summer Analyst", JobType: "Internship", Location: "New York, NY", Source: "Networking Event", AppDeadline: getRecentDate(75), DateApplied: getRecentDate(80), NextStep: "Did not pass online assessment" },
      
      // Automotive
      { id: "job-13", Status: "Applied", Company: "Tesla", Title: "Mechanical Engineer", JobType: "Full-Time", Location: "Fremont, CA", Source: "Company Website", AppDeadline: getTodayPlusDays(30), DateApplied: getRecentDate(1), NextStep: "Resume screening in progress" },
      { id: "job-14", Status: "Final Interview", Company: "Ferrari", Title: "Aerodynamics Engineer", JobType: "Full-Time", Location: "Maranello, Italy", Source: "Polimi CareerService", AppDeadline: getTodayPlusDays(10), DateApplied: getRecentDate(25), NextStep: "Final presentation next Friday" },
      { id: "job-15", Status: "Offer Received", Company: "BMW", Title: "Electric Vehicle Engineer", JobType: "Full-Time", Location: "Munich, Germany", Source: "Referral", AppDeadline: getTodayPlusDays(14), DateApplied: getRecentDate(18), NextStep: "Considering offer - deadline Jan 20" },
      
      // Startups & Scale-ups
      { id: "job-16", Status: "HR Screening", Company: "Stripe", Title: "Product Marketing Manager", JobType: "Full-Time", Location: "San Francisco, CA", Source: "LinkedIn", AppDeadline: getTodayPlusDays(22), DateApplied: getRecentDate(6), NextStep: "Culture fit interview scheduled" },
      { id: "job-17", Status: "Technical Interview", Company: "Revolut", Title: "Backend Developer", JobType: "Full-Time", Location: "London, UK", Source: "Company Website", AppDeadline: getTodayPlusDays(16), DateApplied: getRecentDate(10), NextStep: "System design interview tomorrow" },
      { id: "job-18", Status: "Applied", Company: "Klarna", Title: "UX Designer", JobType: "Full-Time", Location: "Stockholm, Sweden", Source: "LinkedIn", AppDeadline: getTodayPlusDays(35), DateApplied: getRecentDate(3), NextStep: "Portfolio review in progress" },
      
      // Energy & Sustainability
      { id: "job-19", Status: "Case Study / Assessment", Company: "Enel", Title: "Renewable Energy Analyst", JobType: "Full-Time", Location: "Rome, Italy", Source: "Polimi CareerService", AppDeadline: getTodayPlusDays(6), DateApplied: getRecentDate(18), NextStep: "Sustainability project case study due Friday" },
      { id: "job-20", Status: "Applied", Company: "Shell", Title: "Energy Transition Consultant", JobType: "Full-Time", Location: "The Hague, Netherlands", Source: "Company Website", AppDeadline: getTodayPlusDays(28), DateApplied: getRecentDate(5), NextStep: "Online assessment to complete" },
      
      // Aerospace
      { id: "job-21", Status: "HR Screening", Company: "SpaceX", Title: "Propulsion Engineer", JobType: "Full-Time", Location: "Hawthorne, CA", Source: "Referral", AppDeadline: getTodayPlusDays(40), DateApplied: getRecentDate(14), NextStep: "Phone interview with hiring manager" },
      { id: "job-22", Status: "Rejected", Company: "Boeing", Title: "Systems Engineer", JobType: "Full-Time", Location: "Seattle, WA", Source: "Company Website", AppDeadline: getRecentDate(85), DateApplied: getRecentDate(90), NextStep: "Position filled internally" },
      
      // Consumer Goods
      { id: "job-23", Status: "Final Interview", Company: "Unilever", Title: "Brand Manager", JobType: "Full-Time", Location: "London, UK", Source: "Polimi CareerService", AppDeadline: getTodayPlusDays(9), DateApplied: getRecentDate(23), NextStep: "Assessment center next week" },
      { id: "job-24", Status: "Applied", Company: "Nestl√©", Title: "Supply Chain Analyst", JobType: "Internship", Location: "Vevey, Switzerland", Source: "Company Website", AppDeadline: getTodayPlusDays(45), DateApplied: "2025-01-07", NextStep: "Application submitted today" },
      
      // Thesis Projects
      { id: "job-25", Status: "HR Screening", Company: "CERN", Title: "Research Associate", JobType: "Thesis Project", Location: "Geneva, Switzerland", Source: "Networking Event", AppDeadline: getTodayPlusDays(60), DateApplied: getRecentDate(19), NextStep: "Meeting with supervisor next week" },
      { id: "job-26", Status: "Applied", Company: "European Space Agency", Title: "Space Technology Researcher", JobType: "Thesis Project", Location: "Noordwijk, Netherlands", Source: "Other", AppDeadline: getTodayPlusDays(75), DateApplied: getRecentDate(16), NextStep: "Thesis proposal under review" },
      
      // Media & Entertainment
      { id: "job-27", Status: "Technical Interview", Company: "Spotify", Title: "Data Engineer", JobType: "Full-Time", Location: "Stockholm, Sweden", Source: "LinkedIn", AppDeadline: getTodayPlusDays(19), DateApplied: getRecentDate(8), NextStep: "Take-home coding challenge completed" },
      { id: "job-28", Status: "Applied", Company: "Disney", Title: "Creative Technologist", JobType: "Full-Time", Location: "Burbank, CA", Source: "Company Website", AppDeadline: getTodayPlusDays(50), DateApplied: getRecentDate(2), NextStep: "Creative portfolio review" },
      
      // Financial Services
      { id: "job-29", Status: "Offer Received", Company: "BlackRock", Title: "Risk Analyst", JobType: "Full-Time", Location: "New York, NY", Source: "Networking Event", AppDeadline: getTodayPlusDays(12), DateApplied: getRecentDate(21), NextStep: "Offer expires January 18th" },
      { id: "job-30", Status: "HR Screening", Company: "Visa", Title: "Payment Systems Engineer", JobType: "Full-Time", Location: "San Francisco, CA", Source: "LinkedIn", AppDeadline: getTodayPlusDays(26), DateApplied: getRecentDate(6), NextStep: "Behavioral interview scheduled" },
      
      // Wishlist Companies
      { id: "job-31", Status: "Wishlist", Company: "OpenAI", Title: "AI Research Engineer", JobType: "Full-Time", Location: "San Francisco, CA", Source: "Other", AppDeadline: getTodayPlusDays(90), DateApplied: "", NextStep: "Waiting for position to open" },
      { id: "job-32", Status: "Wishlist", Company: "Y Combinator", Title: "Investment Associate", JobType: "Full-Time", Location: "Mountain View, CA", Source: "Networking Event", AppDeadline: getTodayPlusDays(120), DateApplied: "", NextStep: "Building relevant experience first" },
      { id: "job-33", Status: "Wishlist", Company: "ASML", Title: "Lithography Engineer", JobType: "Full-Time", Location: "Veldhoven, Netherlands", Source: "Company Website", AppDeadline: getTodayPlusDays(100), DateApplied: "", NextStep: "Completing relevant coursework" },
      
      // Healthcare & Biotech
      { id: "job-34", Status: "Applied", Company: "Johnson & Johnson", Title: "Medical Device Engineer", JobType: "Full-Time", Location: "New Brunswick, NJ", Source: "Polimi CareerService", AppDeadline: getTodayPlusDays(33), DateApplied: getRecentDate(4), NextStep: "Technical screening pending" },
      { id: "job-35", Status: "Case Study / Assessment", Company: "Novartis", Title: "Digital Health Analyst", JobType: "Internship", Location: "Basel, Switzerland", Source: "Company Website", AppDeadline: getTodayPlusDays(4), DateApplied: getRecentDate(20), NextStep: "Healthcare innovation case study due Monday" },
      
      // Telecommunications
      { id: "job-36", Status: "Technical Interview", Company: "Ericsson", Title: "5G Network Engineer", JobType: "Full-Time", Location: "Stockholm, Sweden", Source: "LinkedIn", AppDeadline: getTodayPlusDays(21), DateApplied: getRecentDate(11), NextStep: "Technical deep-dive interview" },
      { id: "job-37", Status: "Rejected", Company: "Nokia", Title: "RF Engineer", JobType: "Full-Time", Location: "Espoo, Finland", Source: "Company Website", AppDeadline: getRecentDate(120), DateApplied: getRecentDate(125), NextStep: "Position required more experience" },
      
      // Additional Tech
      { id: "job-38", Status: "Applied", Company: "Palantir", Title: "Forward Deployed Engineer", JobType: "Full-Time", Location: "London, UK", Source: "Referral", AppDeadline: getTodayPlusDays(37), DateApplied: getRecentDate(1), NextStep: "Karat technical screen scheduled" },
      { id: "job-39", Status: "HR Screening", Company: "Databricks", Title: "Solutions Architect", JobType: "Full-Time", Location: "Amsterdam, Netherlands", Source: "LinkedIn", AppDeadline: getTodayPlusDays(27), DateApplied: getRecentDate(6), NextStep: "Recruiter call this Thursday" },
      { id: "job-40", Status: "To Apply", Company: "NVIDIA", Title: "GPU Software Engineer", JobType: "Full-Time", Location: "Santa Clara, CA", Source: "Company Website", AppDeadline: getTodayPlusDays(42), DateApplied: "", NextStep: "Preparing application materials" }
    ];
    const sampleContacts = [
      { id: "contact-1", Name: "Mario Rossi", Company: "McKinsey & Co", Role: "Engagement Manager", ContactDate: "2025-05-29", Notes: "Referral for internship" },
      { id: "contact-2", Name: "Giulia Bianchi", Company: "Google", Role: "Recruiter", ContactDate: "2025-05-22", Notes: "Coffee chat, very helpful" },
    ];

    /********* Firebase Services *********/
    const FirebaseService = {
      async saveJobs(userId, jobs) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('jobs');
          await docRef.set({
            jobs: jobs,
            lastUpdated: window.firebase.serverTimestamp()
          });
        } catch (error) {
          console.error('Error saving jobs:', error);
          throw error;
        }
      },

      async loadJobs(userId) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('jobs');
          const docSnap = await docRef.get();
          if (docSnap.exists) {
            return docSnap.data().jobs || [];
          }
          return [];
        } catch (error) {
          console.error('Error loading jobs:', error);
          return [];
        }
      },

      async saveContacts(userId, contacts) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('contacts');
          await docRef.set({
            contacts: contacts,
            lastUpdated: window.firebase.serverTimestamp()
          });
        } catch (error) {
          console.error('Error saving contacts:', error);
          throw error;
        }
      },

      async loadContacts(userId) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('contacts');
          const docSnap = await docRef.get();
          if (docSnap.exists) {
            return docSnap.data().contacts || [];
          }
          return [];
        } catch (error) {
          console.error('Error loading contacts:', error);
          return [];
        }
      }
    };

    /********* Helpers & Custom Hooks *********/
    const emptyJob = { Status:"Wishlist", Company:"", Title:"", JobType:"Internship", Location:"", Source:"Polimi CareerService", AppDeadline:"", DateApplied:"", NextStep:"" };
    const emptyContact = { Name:"", Company:"", Role:"", ContactDate:"", Notes:"" };

    function useAuth() {
      const [user, setUser] = React.useState(null);
      const [loading, setLoading] = React.useState(true);

      React.useEffect(() => {
        const unsubscribe = window.firebase.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      const signIn = async () => {
        try {
          await window.firebase.signInWithPopup(window.firebase.provider);
          showToast('Successfully signed in!', 'success');
        } catch (error) {
          console.error('Sign in error:', error);
          showToast('Failed to sign in. Please try again.', 'error');
        }
      };

      const signOut = async () => {
        try {
          await window.firebase.signOut();
          showToast('Successfully signed out!', 'info');
        } catch (error) {
          console.error('Sign out error:', error);
          showToast('Failed to sign out.', 'error');
        }
      };

      return { user, loading, signIn, signOut };
    }

    function useFirebaseData(user) {
      const [jobs, setJobs] = React.useState([]);
      const [contacts, setContacts] = React.useState([]);
      const [loading, setLoading] = React.useState(true);

      // Load data when user changes
      React.useEffect(() => {
        if (user) {
          loadUserData();
        } else {
          setJobs([]);
          setContacts([]);
          setLoading(false);
        }
      }, [user]);

      const loadUserData = async () => {
        if (!user) return;
        
        setLoading(true);
        try {
          const [jobsData, contactsData] = await Promise.all([
            FirebaseService.loadJobs(user.uid),
            FirebaseService.loadContacts(user.uid)
          ]);
          setJobs(jobsData);
          setContacts(contactsData);
        } catch (error) {
          console.error('Error loading user data:', error);
          showToast('Failed to load your data.', 'error');
        }
        setLoading(false);
      };

      const updateJobs = async (updater) => {
        if (!user) throw new Error("User not authenticated");
        
        const newJobs = typeof updater === 'function' ? updater(jobs) : updater;
        setJobs(newJobs); // Optimistic update
        
        try {
          await FirebaseService.saveJobs(user.uid, newJobs);
        } catch (error) {
          // If save fails, revert to original state and throw error
          setJobs(jobs); 
          throw error;
        }
      };

      const updateContacts = async (updater) => {
        if (!user) throw new Error("User not authenticated");

        const newContacts = typeof updater === 'function' ? updater(contacts) : updater;
        setContacts(newContacts); // Optimistic update
        
        try {
          await FirebaseService.saveContacts(user.uid, newContacts);
        } catch (error) {
          // If save fails, revert to original state and throw error
          setContacts(contacts);
          throw error;
        }
      };

      return { jobs, contacts, loading, updateJobs, updateContacts, loadUserData };
    }

    function useLocalStorage(key, initialValue) {
      const [storedValue, setStoredValue] = React.useState(() => {
        try { const item = window.localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; } 
        catch (error) { return initialValue; }
      });
      const setValue = (value) => {
        try {
          const valueToStore = value instanceof Function ? value(storedValue) : value;
          setStoredValue(valueToStore);
          window.localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (error) { console.error(error); }
      };
      return [storedValue, setValue];
    }
    
    const showToast = (message, type = 'success') => {
        const toastContainer = document.getElementById('toast-container');
        const toastId = `toast-${Date.now()}`;
        const alertClass = { success: 'alert-success', error: 'alert-error', info: 'alert-info' }[type];
        const toastElement = document.createElement('div');
        toastElement.id = toastId;
        toastElement.className = `alert ${alertClass} shadow-lg`;
        toastElement.innerHTML = `<span>${message}</span>`;
        toastContainer.appendChild(toastElement);
        setTimeout(() => { toastElement.remove() }, 3000);
    };

    const getDeadlineClass = (deadline) => {
      if (!deadline) return '';
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const deadlineDate = new Date(deadline);
      const diffDays = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
      if (diffDays <= 0) return 'text-error font-bold';
      if (diffDays <= 3) return 'text-warning font-bold';
      if (diffDays <= 7) return 'text-success font-bold';
      return '';
    };

    /********* Reusable Components *********/
    function Icon({ name, className = "", ...props }) {
      React.useEffect(() => {
        if (typeof feather !== 'undefined') {
          feather.replace();
        }
      }, []);

      if (typeof feather === 'undefined' || !feather.icons[name]) {
        // Fallback to simple span with emoji or text
        const fallbacks = {
          'briefcase': 'üíº',
          'settings': '‚öôÔ∏è',
          'download': '‚¨áÔ∏è',
          'upload': '‚¨ÜÔ∏è',
          'mail': '‚úâÔ∏è',
          'refresh-cw': 'üîÑ',
          'trash': 'üóëÔ∏è',
          'plus': '‚ûï',
          'filter': 'üîç',
          'filter-x': '‚ùå',
          'layers': 'üìö',
          'clock': '‚è∞',
          'thumbs-up': 'üëç',
          'x-circle': '‚ùå',
          'trending-up': 'üìà',
          'map-pin': 'üìç',
          'maximize-2': '‚õ∂',
          'copy': 'üìã',
          'check': '‚úÖ',
          'info': '‚ÑπÔ∏è',
          'send': 'üì§',
          'heart': '‚ù§Ô∏è',
          'users': 'üë•',
          'monitor': 'üíª',
          'cloud': '‚òÅÔ∏è',
          'check-circle': '‚úÖ',
          'download-cloud': '‚òÅÔ∏è‚¨áÔ∏è',
          'inbox': 'üì•',
          'user': 'üë§',
          'log-out': 'üö™',
          'lock': 'üîí',
          'target': 'üéØ',
          'pie-chart': 'üìä'
        };
        return React.createElement('span', { className: `inline-block ${className}`, ...props }, fallbacks[name] || '‚ö´');
      }

      return React.createElement('span', {
        className: `inline-block ${className}`,
        dangerouslySetInnerHTML: { __html: feather.icons[name].toSvg() },
        ...props
      });
    }

    function Modal({ id, title, children }) {
        return (
            <dialog id={id} className="modal">
                <div className="modal-box w-11/12 max-w-2xl"><form method="dialog"><button className="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button></form><h3 className="font-bold text-lg mb-4">{title}</h3>{children}</div>
                <form method="dialog" className="modal-backdrop"><button>close</button></form>
            </dialog>
        );
    }
    
    function ChartComponent({ chartId, type, data, options }) {
      const chartRef = React.useRef(null);
      React.useEffect(() => {
        const ctx = document.getElementById(chartId).getContext('2d');
        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(ctx, { type, data, options });
        return () => chartRef.current?.destroy();
      }, [data]);
      return <canvas id={chartId} style={{maxHeight: '220px'}}></canvas>;
    }

    /********* Auth Components *********/
    function AuthScreen() {
      return (
        <div className="min-h-screen bg-gradient-to-br from-gray-50 to-blue-100 flex items-center justify-center p-4 font-sans">
          <div className="w-full max-w-md mx-auto">
            <div className="bg-white/90 backdrop-blur-lg rounded-2xl shadow-2xl p-8 text-center">
              <div className="mb-8">
                <div className="bg-blue-600 shadow-lg shadow-blue-600/30 p-4 rounded-full w-16 h-16 mx-auto mb-4 inline-flex items-center justify-center">
                  <Icon name="briefcase" className="w-8 h-8 text-white"/>
                </div>
                <h1 className="text-4xl font-bold text-gray-900">CareerFlow</h1>
                <p className="text-gray-600 mt-2 text-lg">Your All-in-One Application Tracker</p>
              </div>
              
              <div className="space-y-6">
                <div className="text-center">
                  <h2 className="text-xl font-semibold text-gray-800 mb-4">Let's get you signed in.</h2>
                  <AuthButton />
                </div>
                <div className="text-center text-xs text-gray-500">
                  <p><Icon name="lock" className="w-3 h-3 inline-block mr-1"/> Your data is securely stored and synced across devices.</p>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-3 gap-4 text-center mt-8 text-gray-600 px-4">
              <div className="p-2 flex flex-col items-center gap-2">
                <Icon name="target" className="w-6 h-6 text-blue-500"/>
                <p className="text-xs font-semibold">Track Every Detail</p>
              </div>
              <div className="p-2 flex flex-col items-center gap-2">
                <Icon name="pie-chart" className="w-6 h-6 text-blue-500"/>
                <p className="text-xs font-semibold">Visualize Your Progress</p>
              </div>
              <div className="p-2 flex flex-col items-center gap-2">
                <Icon name="cloud" className="w-6 h-6 text-blue-500"/>
                <p className="text-xs font-semibold">Secure & Synced</p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function AuthButton() {
      const { signIn } = useAuth();
      
      return (
        <button 
          onClick={signIn}
          className="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 flex items-center justify-center gap-3 hover:bg-gray-50 transition-colors duration-200 shadow-sm"
        >
          <svg className="w-5 h-5" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Continue with Google
        </button>
      );
    }

    function UserProfile({ user, onSignOut }) {
      return (
        <div className="dropdown dropdown-end">
          <div tabIndex={0} role="button" className="btn btn-ghost btn-circle avatar">
            <div className="w-8 rounded-full">
              <img src={user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=3b82f6&color=fff`} alt="Profile" />
            </div>
          </div>
          <ul tabIndex={0} className="menu menu-sm dropdown-content mt-3 z-[10] p-2 shadow-lg bg-white rounded-xl border border-gray-200 w-64">
            <li className="p-2 border-b border-gray-100">
              <div className="flex flex-col">
                <span className="font-medium text-gray-900">{user.displayName || 'User'}</span>
                <span className="text-xs text-gray-500">{user.email}</span>
              </div>
            </li>
            <li><a onClick={onSignOut} className="text-red-600 hover:bg-red-50"><Icon name="log-out" className="w-4 h-4"/> Sign Out</a></li>
          </ul>
        </div>
      );
    }
    
    /********* Main Components *********/
    function ExportModal({ onCancel, jobs, contacts }) {
      const [exportOption, setExportOption] = React.useState('computer');
      const [fileName, setFileName] = React.useState(() => {
        const today = new Date().toISOString().split('T')[0];
        return `careerflow-backup-${today}`;
      });
      const [isExporting, setIsExporting] = React.useState(false);

      const handleExport = async () => {
        if (!fileName.trim()) {
          showToast('Please enter a filename', 'error');
          return;
        }

        setIsExporting(true);
        
        try {
          if (exportOption === 'computer') {
            // Export to computer
            const data = {
              exportDate: new Date().toISOString(),
              version: "1.0",
              jobs: jobs || [],
              contacts: contacts || []
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully!', 'success');
            onCancel();
          } else if (exportOption === 'drive') {
            // Google Drive integration would go here
            showToast('Google Drive integration coming soon!', 'info');
          }
        } catch (error) {
          showToast('Export failed. Please try again.', 'error');
        } finally {
          setIsExporting(false);
        }
      };

      return (
        <div className="space-y-6">
          <div className="text-center mb-6">
            <Icon name="download-cloud" className="w-16 h-16 text-blue-500 mx-auto mb-4"/>
            <h3 className="text-xl font-semibold text-gray-800">Export Your Data</h3>
            <p className="text-sm text-gray-600 mt-2">
              Save your applications and contacts data
            </p>
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Export Options</label>
              <div className="space-y-3">
                <label className={`flex items-center p-4 border rounded-lg cursor-pointer transition-all ${
                  exportOption === 'computer' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'
                }`}>
                  <input 
                    type="radio" 
                    name="exportOption" 
                    value="computer" 
                    checked={exportOption === 'computer'}
                    onChange={(e) => setExportOption(e.target.value)}
                    className="sr-only"
                  />
                  <div className="flex-1">
                    <div className="flex items-center">
                      <Icon name="monitor" className="w-5 h-5 text-blue-600 mr-3"/>
                      <span className="font-medium text-gray-800">üíª Save to Computer</span>
                    </div>
                    <p className="text-sm text-gray-600 mt-1 ml-8">Download as JSON file to your Downloads folder</p>
                  </div>
                  {exportOption === 'computer' && (
                    <Icon name="check-circle" className="w-5 h-5 text-blue-600"/>
                  )}
                </label>

                <label className={`flex items-center p-4 border rounded-lg cursor-pointer transition-all ${
                  exportOption === 'drive' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'
                }`}>
                  <input 
                    type="radio" 
                    name="exportOption" 
                    value="drive" 
                    checked={exportOption === 'drive'}
                    onChange={(e) => setExportOption(e.target.value)}
                    className="sr-only"
                  />
                  <div className="flex-1">
                    <div className="flex items-center">
                      <Icon name="cloud" className="w-5 h-5 text-green-600 mr-3"/>
                      <span className="font-medium text-gray-800">‚òÅÔ∏è Save to Google Drive</span>
                      <span className="ml-2 px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">Coming Soon</span>
                    </div>
                    <p className="text-sm text-gray-600 mt-1 ml-8">Backup directly to your Google Drive</p>
                  </div>
                  {exportOption === 'drive' && (
                    <Icon name="check-circle" className="w-5 h-5 text-blue-600"/>
                  )}
                </label>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">File Name</label>
              <input 
                type="text" 
                value={fileName}
                onChange={(e) => setFileName(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enter filename (without extension)"
              />
            </div>

            <div className="bg-gray-50 rounded-lg p-4">
              <h4 className="font-medium text-gray-800 mb-2">Export Summary</h4>
                              <div className="space-y-1 text-sm text-gray-600">
                  <div className="flex justify-between">
                    <span>Applications:</span>
                    <span className="font-medium">{jobs?.length || 0}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Contacts:</span>
                    <span className="font-medium">{contacts?.length || 0}</span>
                  </div>
                <div className="flex justify-between">
                  <span>Export Date:</span>
                  <span className="font-medium">{new Date().toLocaleDateString()}</span>
                </div>
              </div>
            </div>
          </div>

          <div className="flex gap-3 pt-4">
            <button 
              onClick={onCancel}
              className="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
              disabled={isExporting}
            >
              Cancel
            </button>
            <button 
              onClick={handleExport}
              disabled={isExporting || !fileName.trim()}
              className="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
            >
              {isExporting ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                  Exporting...
                </>
              ) : (
                <>
                  <Icon name="download" className="w-4 h-4"/>
                  Export Data
                </>
              )}
            </button>
          </div>
        </div>
      );
    }

    function EmailTemplatesModal({ onCancel }) {
      const [selectedTemplate, setSelectedTemplate] = React.useState('followUp');
      const [copiedField, setCopiedField] = React.useState(null);

      const copyToClipboard = async (text, field) => {
        try {
          await navigator.clipboard.writeText(text);
          setCopiedField(field);
          showToast('Copied to clipboard!', 'success');
          setTimeout(() => setCopiedField(null), 2000);
        } catch (error) {
          showToast('Failed to copy to clipboard', 'error');
        }
      };

      const templates = [
        { id: 'followUp', name: 'Follow-up Email', icon: 'send', color: 'blue' },
        { id: 'thankYou', name: 'Thank You Email', icon: 'heart', color: 'green' },
        { id: 'networking', name: 'Networking Email', icon: 'users', color: 'purple' }
      ];

      return (
        <div className="space-y-6">
          <div className="text-center mb-6">
            <Icon name="mail" className="w-16 h-16 text-purple-500 mx-auto mb-4"/>
            <h3 className="text-xl font-semibold text-gray-800">Email Templates</h3>
            <p className="text-sm text-gray-600 mt-2">
              Professional email templates for your job search
            </p>
          </div>

          <div className="flex space-x-2 mb-4">
            {templates.map(template => (
              <button
                key={template.id}
                onClick={() => setSelectedTemplate(template.id)}
                className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                  selectedTemplate === template.id
                    ? `bg-${template.color}-100 text-${template.color}-700 border border-${template.color}-200`
                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                }`}
              >
                <Icon name={template.icon} className="w-4 h-4 inline mr-2"/>
                {template.name}
              </button>
            ))}
          </div>

          <div className="space-y-4">
            <div>
              <div className="flex items-center justify-between mb-2">
                <label className="block text-sm font-medium text-gray-700">Subject</label>
                <button
                  onClick={() => copyToClipboard(emailTemplates[selectedTemplate].subject, 'subject')}
                  className="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-blue-50 transition-colors"
                >
                  <Icon name={copiedField === 'subject' ? 'check' : 'copy'} className="w-3 h-3"/>
                  <span>{copiedField === 'subject' ? 'Copied!' : 'Copy'}</span>
                </button>
              </div>
              <div className="p-3 bg-gray-50 rounded-lg border text-sm">
                {emailTemplates[selectedTemplate].subject}
              </div>
            </div>

            <div>
              <div className="flex items-center justify-between mb-2">
                <label className="block text-sm font-medium text-gray-700">Email Body</label>
                <button
                  onClick={() => copyToClipboard(emailTemplates[selectedTemplate].body, 'body')}
                  className="text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-blue-50 transition-colors"
                >
                  <Icon name={copiedField === 'body' ? 'check' : 'copy'} className="w-3 h-3"/>
                  <span>{copiedField === 'body' ? 'Copied!' : 'Copy'}</span>
                </button>
              </div>
              <div className="p-3 bg-gray-50 rounded-lg border text-sm whitespace-pre-line max-h-64 overflow-y-auto">
                {emailTemplates[selectedTemplate].body}
              </div>
            </div>

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
              <div className="flex items-start gap-2">
                <Icon name="info" className="w-4 h-4 text-blue-600 mt-0.5"/>
                <div className="text-sm">
                  <p className="font-medium text-blue-800">Customization Tips:</p>
                  <p className="text-blue-700 mt-1">
                    Replace placeholders like [Company Name], [Position Title], [Your Name] with your specific details before sending.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div className="flex gap-3 pt-4">
            <button 
              onClick={onCancel}
              className="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
            >
              Close
            </button>
            <button 
              onClick={() => copyToClipboard(`${emailTemplates[selectedTemplate].subject}\n\n${emailTemplates[selectedTemplate].body}`, 'full')}
              className="flex-1 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors flex items-center justify-center gap-2"
            >
              <Icon name="copy" className="w-4 h-4"/>
              Copy Complete Email
            </button>
          </div>
        </div>
      );
    }
    
    function Analytics({ jobs, selectedMetricFilters, onMetricFilterToggle }) {
      const metrics = React.useMemo(() => {
        return jobs.reduce((acc, job) => {
          acc.total++;
          if (["Offer Received", "Offer Accepted"].includes(job.Status)) acc.offers++;
          else if (job.Status === "Rejected") acc.rejected++;
          else if (["Applied", "HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview"].includes(job.Status)) acc.inProgress++;
          return acc;
        }, { total: 0, offers: 0, rejected: 0, inProgress: 0 });
      }, [jobs]);

      const timelineData = React.useMemo(() => {
        // Group applications by month for timeline
        const monthlyData = {};
        const today = new Date();
        
        // Initialize last 6 months
        for (let i = 5; i >= 0; i--) {
          const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
          const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          monthlyData[monthKey] = { applied: 0, offers: 0, rejected: 0 };
        }
        
        jobs.forEach(job => {
          if (job.DateApplied) {
            const appDate = new Date(job.DateApplied);
            const monthKey = appDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            
            if (monthlyData[monthKey]) {
              monthlyData[monthKey].applied++;
              if (["Offer Received", "Offer Accepted"].includes(job.Status)) {
                monthlyData[monthKey].offers++;
              } else if (job.Status === "Rejected") {
                monthlyData[monthKey].rejected++;
              }
            }
          }
        });

        const labels = Object.keys(monthlyData);
        const appliedData = Object.values(monthlyData).map(m => m.applied);
        const offersData = Object.values(monthlyData).map(m => m.offers);
        const rejectedData = Object.values(monthlyData).map(m => m.rejected);

        return {
          labels,
          datasets: [
            {
              label: 'Applications',
              data: appliedData,
              borderColor: '#3B82F6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#3B82F6',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8,
            },
            {
              label: 'Offers',
              data: offersData,
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#10B981',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8,
            },
            {
              label: 'Rejections',
              data: rejectedData,
              borderColor: '#EF4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#EF4444',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8,
            }
          ]
        };
      }, [jobs]);

      const doughnutData = {
        labels: ['Offers', 'Rejected', 'In-Progress', 'Other'],
        datasets: [{
          data: [metrics.offers, metrics.rejected, metrics.inProgress, metrics.total - metrics.offers - metrics.rejected - metrics.inProgress],
          backgroundColor: ['#10B981', '#EF4444', '#F59E0B', '#8B5CF6'],
          borderWidth: 0,
          borderRadius: 8,
          spacing: 2,
        }]
      };
      
      const barData = {
        labels: statusList,
        datasets: [{
          label: 'Applications',
          data: statusList.map(s => jobs.filter(j => j.Status === s).length),
          backgroundColor: statusList.map((_, i) => {
            const colors = ['#8B5CF6', '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1', '#14B8A6'];
            return colors[i % colors.length];
          }),
          borderRadius: 4,
          borderSkipped: false,
        }]
      };

      return (
        <div className="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl border border-gray-100">
          <div className="p-6 space-y-6">
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className={`bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 border-blue-200/50 hover:shadow-md`} onClick={() => onMetricFilterToggle('total')}>
                    <div className="text-xs font-medium text-blue-600 uppercase tracking-wide mb-2">Clear Filters</div>
                    <div className="text-2xl font-bold text-blue-700 mb-2">
                      {metrics.total}
                    </div>
                    <div className="flex items-center justify-center gap-1 text-xs text-blue-600">
                      <Icon name="filter-x" className="w-3 h-3"/>
                      <span>Total Apps</span>
                    </div>
                  </div>
                  <div className={`bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 ${
                    selectedMetricFilters.includes('inProgress') ? 'border-amber-400 ring-2 ring-amber-200 shadow-lg' : 'border-amber-200/50 hover:shadow-md'
                  }`} onClick={() => onMetricFilterToggle('inProgress')}>
                    <div className="text-xs font-medium text-amber-600 uppercase tracking-wide">In Progress</div>
                    <div className="text-2xl font-bold text-amber-700 mt-1 flex items-center justify-center gap-2">
                      {metrics.inProgress} <Icon name="clock" className="w-5 h-5"/>
                    </div>
                    {selectedMetricFilters.includes('inProgress') && (
                      <div className="mt-2"><span className="inline-block w-2 h-2 bg-amber-500 rounded-full"></span></div>
                    )}
                  </div>
                  <div className={`bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 ${
                    selectedMetricFilters.includes('offers') ? 'border-emerald-400 ring-2 ring-emerald-200 shadow-lg' : 'border-emerald-200/50 hover:shadow-md'
                  }`} onClick={() => onMetricFilterToggle('offers')}>
                    <div className="text-xs font-medium text-emerald-600 uppercase tracking-wide">Offers</div>
                    <div className="text-2xl font-bold text-emerald-700 mt-1 flex items-center justify-center gap-2">
                      {metrics.offers} <Icon name="thumbs-up" className="w-5 h-5"/>
                    </div>
                    {selectedMetricFilters.includes('offers') && (
                      <div className="mt-2"><span className="inline-block w-2 h-2 bg-emerald-500 rounded-full"></span></div>
                    )}
                  </div>
                  <div className={`bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 ${
                    selectedMetricFilters.includes('rejected') ? 'border-red-400 ring-2 ring-red-200 shadow-lg' : 'border-red-200/50 hover:shadow-md'
                  }`} onClick={() => onMetricFilterToggle('rejected')}>
                    <div className="text-xs font-medium text-red-600 uppercase tracking-wide">Rejected</div>
                    <div className="text-2xl font-bold text-red-700 mt-1 flex items-center justify-center gap-2">
                      {metrics.rejected} <Icon name="x-circle" className="w-5 h-5"/>
                    </div>
                    {selectedMetricFilters.includes('rejected') && (
                      <div className="mt-2"><span className="inline-block w-2 h-2 bg-red-500 rounded-full"></span></div>
                    )}
                  </div>
              </div>

              {jobs.length > 0 ? (
                <div className="space-y-8">
                  <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                    <h3 className="font-semibold text-lg text-gray-800 mb-6 flex items-center gap-2">
                      <Icon name="trending-up" className="w-5 h-5 text-blue-500"/>
                      Application Timeline - Last 6 Months
                    </h3>
                    <div style={{height: '300px'}}>
                      <ChartComponent chartId="timeline-chart" type="line" data={timelineData} options={{
                        maintainAspectRatio: false,
                        responsive: true,
                        plugins: {
                          legend: {
                            display: true,
                            position: 'top',
                            labels: {
                              usePointStyle: true,
                              padding: 20,
                              font: { size: 12, weight: '500' }
                            }
                          },
                          tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(0,0,0,0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            intersect: false,
                            mode: 'index'
                          }
                        },
                        scales: {
                          x: {
                            grid: { color: '#F3F4F6', lineWidth: 1 },
                            ticks: { color: '#6B7280', font: { size: 11, weight: '500' } },
                            border: { display: false }
                          },
                          y: {
                            beginAtZero: true,
                            grid: { color: '#F3F4F6', lineWidth: 1 },
                            ticks: { 
                              stepSize: 1, 
                              color: '#6B7280', 
                              font: { size: 11 },
                              callback: function(value) { return Math.floor(value) === value ? value : ''; }
                            },
                            border: { display: false }
                          }
                        },
                        elements: {
                          line: { borderJoinStyle: 'round' },
                          point: { hoverBorderWidth: 3 }
                        },
                        interaction: {
                          intersect: false,
                          mode: 'index'
                        },
                        animation: {
                          duration: 1200,
                          easing: 'easeInOutCubic',
                          delay: (context) => context.dataIndex * 100
                        }
                      }} />
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                      <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                          <h3 className="font-semibold text-lg text-gray-800 mb-4 text-center">Pipeline Overview</h3>
                          <div className="flex justify-center mb-4">
                            <ChartComponent chartId="chart1" type="doughnut" data={doughnutData} options={{plugins:{legend:{display:false}}, cutout: '70%', maintainAspectRatio: false}} />
                          </div>
                          <div className="grid grid-cols-2 gap-3">
                            {doughnutData.labels.map((label, i) => (
                              <div key={label} className="flex items-center gap-2 text-sm bg-gray-50 rounded-lg p-2">
                                <div className="w-3 h-3 rounded-full" style={{backgroundColor: doughnutData.datasets[0].backgroundColor[i]}}></div>
                                <span className="font-medium text-gray-700">{label}</span>
                              </div>
                            ))}
                          </div>
                      </div>
                      <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                          <h3 className="font-semibold text-lg text-gray-800 mb-4">Status Distribution</h3>
                          <div style={{height: '280px'}}>
                            <ChartComponent chartId="chart2" type="bar" data={barData} options={{
                              indexAxis:'y', 
                              maintainAspectRatio: false, 
                              plugins:{
                                legend:{display:false},
                                tooltip: {
                                  backgroundColor: 'rgba(0,0,0,0.8)',
                                  titleColor: 'white',
                                  bodyColor: 'white',
                                  borderColor: 'rgba(0,0,0,0.1)',
                                  borderWidth: 1
                                }
                              }, 
                              scales:{
                                x:{
                                  beginAtZero:true, 
                                  ticks: {stepSize: 1, color: '#6B7280', font: {size: 11}}, 
                                  grid: {color: '#F3F4F6', lineWidth: 1},
                                  border: {display: false}
                                }, 
                                y:{
                                  ticks: {color: '#374151', font: {size: 11, weight: '500'}},
                                  grid: {display: false},
                                  border: {display: false}
                                }
                              },
                              elements: {bar: {borderRadius: 4}},
                              layout: {padding: {left: 10, right: 20}},
                              animation: {duration: 800, easing: 'easeInOutQuart'}
                            }} />
                          </div>
                      </div>
                  </div>
                </div>
              ) : (
                <div className="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                    <Icon name="pie-chart" className="w-16 h-16 mx-auto text-gray-300" />
                    <p className="mt-4 text-xl font-semibold text-gray-600">No data to display</p>
                    <p className="text-sm text-gray-500 mt-1">Add your first application to see analytics</p>
                </div>
              )}
          </div>
        </div>
      );
    }
    
    function JobForm({ jobData, onSave, onCancel }) {
        const [job, setJob] = React.useState(jobData);
        const handleChange = (field, value) => setJob(prev => ({ ...prev, [field]: value }));
        const handleSave = () => onSave({ ...job, id: job.id || `job-${Date.now()}` });
        
        return (
            <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><label className="form-control w-full"><div className="label"><span className="label-text">Company</span></div><input type="text" placeholder="e.g., Google" className="input input-bordered w-full" value={job.Company} onChange={e => handleChange('Company', e.target.value)} /></label><label className="form-control w-full"><div className="label"><span className="label-text">Job Title</span></div><input type="text" placeholder="e.g., Software Engineer" className="input input-bordered w-full" value={job.Title} onChange={e => handleChange('Title', e.target.value)} /></label></div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4"><label className="form-control w-full"><div className="label"><span className="label-text">Status</span></div><select className="select select-bordered" value={job.Status} onChange={e => handleChange('Status', e.target.value)}>{statusList.map(s => <option key={s}>{s}</option>)}</select></label><label className="form-control w-full"><div className="label"><span className="label-text">Job Type</span></div><select className="select select-bordered" value={job.JobType} onChange={e => handleChange('JobType', e.target.value)}>{jobTypeList.map(t => <option key={t}>{t}</option>)}</select></label><label className="form-control w-full"><div className="label"><span className="label-text">Source</span></div><select className="select select-bordered" value={job.Source} onChange={e => handleChange('Source', e.target.value)}>{sourceList.map(s => <option key={s}>{s}</option>)}</select></label></div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4"><label className="form-control w-full"><div className="label"><span className="label-text">Location</span></div><input type="text" placeholder="e.g., Milan" className="input input-bordered w-full" value={job.Location} onChange={e => handleChange('Location', e.target.value)} /></label><label className="form-control w-full"><div className="label"><span className="label-text">Application Deadline</span></div><input type="date" className="input input-bordered w-full" value={job.AppDeadline} onChange={e => handleChange('AppDeadline', e.target.value)} /></label><label className="form-control w-full"><div className="label"><span className="label-text">Date Applied</span></div><input type="date" className="input input-bordered w-full" value={job.DateApplied} onChange={e => handleChange('DateApplied', e.target.value)} /></label></div>
                <label className="form-control w-full"><div className="label"><span className="label-text">Next Step / Notes</span></div><input type="text" placeholder="e.g., Prepare for interview" className="input input-bordered w-full" value={job.NextStep} onChange={e => handleChange('NextStep', e.target.value)} /></label>
                <div className="modal-action"><button className="btn" onClick={onCancel}>Cancel</button><button className="btn btn-primary" onClick={handleSave}>Save</button></div>
            </div>
        );
    }
    
    function TrackerTable({ jobs, setJobs, searchTerm }) {
      const updateJob = async (id, field, value) => {
        try {
          await setJobs(jobs.map(j => j.id === id ? { ...j, [field]: value } : j));
        } catch {
          showToast('Failed to sync changes. Please try again.', 'error');
        }
      };
      
      const deleteJob = async (id) => { 
        if(confirm('Are you sure?')) {
          try {
            await setJobs(jobs.filter(j => j.id !== id)); 
            showToast('Application deleted.', 'info');
          } catch {
            showToast('Failed to delete application. Please try again.', 'error');
          }
        }
      };

      const [expandedNextStep, setExpandedNextStep] = React.useState(null);

      const getStatusRowColor = (status) => {
        const colors = {
          'Applied': 'bg-blue-50 border-l-4 border-l-blue-200',
          'HR Screening': 'bg-amber-50 border-l-4 border-l-amber-200', 
          'Technical Interview': 'bg-purple-50 border-l-4 border-l-purple-200',
          'Case Study / Assessment': 'bg-indigo-50 border-l-4 border-l-indigo-200',
          'Final Interview': 'bg-emerald-50 border-l-4 border-l-emerald-200',
          'Offer Received': 'bg-green-50 border-l-4 border-l-green-300',
          'Offer Accepted': 'bg-green-100 border-l-4 border-l-green-400',
          'Rejected': 'bg-red-50 border-l-4 border-l-red-200',
          'On Hold': 'bg-gray-50 border-l-4 border-l-gray-200'
        };
        return colors[status] || 'bg-white';
      };
      
      return (
        <div className="p-6">
          {jobs.length === 0 ? (
              <div className="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                <Icon name="inbox" className="w-16 h-16 mx-auto text-gray-300" />
                <p className="mt-4 text-xl font-semibold text-gray-600">No applications yet</p>
                <p className="text-sm text-gray-500 mt-1">Click "New Application" to get started</p>
              </div>
          ) : (
              <div className="overflow-x-auto">
                  <table className="w-full table-auto">
                    <thead>
                      <tr className="border-b border-gray-200">
                        <th className="text-left py-4 px-2 font-semibold text-gray-700 text-sm min-w-[130px]">Status</th>
                        <th className="text-left py-4 px-2 font-semibold text-gray-700 text-sm min-w-[140px]">Company</th>
                        <th className="text-left py-4 px-2 font-semibold text-gray-700 text-sm min-w-[160px]">Role</th>
                        <th className="text-left py-4 px-2 font-semibold text-gray-700 text-sm min-w-[120px]">Location</th>
                        <th className="text-left py-4 px-2 font-semibold text-gray-700 text-sm min-w-[120px]">Type</th>
                        <th className="text-left py-4 px-2 font-semibold text-gray-700 text-sm min-w-[130px]">Source</th>
                        <th className="text-left py-4 px-2 font-semibold text-gray-700 text-sm min-w-[110px]">Deadline</th>
                        <th className="text-left py-4 px-2 font-semibold text-gray-700 text-sm min-w-[200px]">Next Step</th>
                        <th className="text-left py-4 px-2 font-semibold text-gray-700 text-sm w-12"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {jobs.map((j) => (
                        <tr key={j.id} className={`border-b border-gray-100 hover:bg-opacity-30 hover:bg-gray-100 transition-all duration-200 ${getStatusRowColor(j.Status)}`}>
                          <td className="py-3 px-2">
                            <select className="w-full bg-transparent border-none text-xs font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                    value={j.Status} onChange={e => updateJob(j.id, 'Status', e.target.value)}>
                              {statusList.map(s => <option key={s}>{s}</option>)}
                            </select>
                          </td>
                          <td className="py-3 px-2">
                            <input type="text" className="w-full bg-transparent border-none text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                   value={j.Company} onChange={e => updateJob(j.id, 'Company', e.target.value)} placeholder="Company" />
                          </td>
                          <td className="py-3 px-2">
                            <input type="text" className="w-full bg-transparent border-none text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                   value={j.Title} onChange={e => updateJob(j.id, 'Title', e.target.value)} placeholder="Job title" />
                          </td>
                          <td className="py-3 px-2 relative">
                            <div className="flex items-center gap-2">
                              <input type="text" 
                                     className="flex-1 bg-transparent border-none text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                     value={j.Location} 
                                     onChange={e => updateJob(j.id, 'Location', e.target.value)} 
                                     placeholder="Location" />
                              {j.Location && j.Location.trim() && (
                                <button 
                                  className="text-blue-500 hover:text-blue-700 text-xs p-1 rounded transition-colors"
                                  onClick={() => {
                                    const mapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(j.Location)}`;
                                    window.open(mapsUrl, '_blank');
                                  }}
                                  title="Open in Google Maps"
                                >
                                  <Icon name="map-pin" className="w-3 h-3" />
                                </button>
                              )}
                            </div>
                          </td>
                          <td className="py-3 px-2">
                            <select className="w-full bg-transparent border-none text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                    value={j.JobType} onChange={e => updateJob(j.id, 'JobType', e.target.value)}>
                              {jobTypeList.map(s => <option key={s}>{s}</option>)}
                            </select>
                          </td>
                          <td className="py-3 px-2">
                            <select className="w-full bg-transparent border-none text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                    value={j.Source} onChange={e => updateJob(j.id, 'Source', e.target.value)}>
                              {sourceList.map(s => <option key={s}>{s}</option>)}
                            </select>
                          </td>
                          <td className={`py-3 px-2 ${getDeadlineClass(j.AppDeadline)}`}>
                            <input type="date" className="w-full bg-transparent border-none text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                   value={j.AppDeadline} onChange={e => updateJob(j.id, 'AppDeadline', e.target.value)} />
                          </td>
                          <td className="py-3 px-2 relative">
                            <div className="flex items-center gap-2">
                              <input type="text" 
                                     className="flex-1 bg-transparent border-none text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                     value={j.NextStep} 
                                     onChange={e => updateJob(j.id, 'NextStep', e.target.value)} 
                                     placeholder="Next step" 
                                     onFocus={() => setExpandedNextStep(j.id)}
                                     onBlur={() => setTimeout(() => setExpandedNextStep(null), 150)} />
                              {j.NextStep && j.NextStep.length > 20 && (
                                <button 
                                  className="text-blue-500 hover:text-blue-700 text-xs p-1 rounded"
                                  onClick={() => setExpandedNextStep(expandedNextStep === j.id ? null : j.id)}
                                  title="Expand next step"
                                >
                                  <Icon name="maximize-2" className="w-3 h-3" />
                                </button>
                              )}
                            </div>
                            {expandedNextStep === j.id && j.NextStep && (
                              <div className="absolute top-full left-0 right-0 z-20 bg-white border border-gray-200 rounded-lg shadow-lg p-3 mt-1">
                                <textarea 
                                  className="w-full border-none resize-none text-xs focus:outline-none"
                                  value={j.NextStep}
                                  onChange={e => updateJob(j.id, 'NextStep', e.target.value)}
                                  rows={3}
                                  placeholder="Describe your next step..."
                                />
                                <div className="flex justify-end mt-2">
                                  <button 
                                    className="text-xs text-gray-500 hover:text-gray-700"
                                    onClick={() => setExpandedNextStep(null)}
                                  >
                                    Close
                                  </button>
                                </div>
                              </div>
                            )}
                          </td>
                          <td className="py-3 px-2">
                            <button className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors duration-150" 
                                    onClick={() => deleteJob(j.id)}>
                              <Icon name="trash-2" className="w-4 h-4" />
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
          )}
        </div>
      );
    }
    
    function ContactsTable({ contacts, setContacts, searchTerm }) {
        const updateContact = async (id, field, value) => {
          try {
            await setContacts(contacts.map(c => c.id === id ? { ...c, [field]: value } : c));
          } catch {
            showToast('Failed to sync contact. Please try again.', 'error');
          }
        };

        const deleteContact = async (id) => { 
          if(confirm('Are you sure?')) {
            try {
              await setContacts(contacts.filter(c => c.id !== id)); 
              showToast('Contact deleted.', 'info');
            } catch {
              showToast('Failed to delete contact. Please try again.', 'error');
            }
          }
        };
        
        const addContact = async (contact) => { 
          try {
            await setContacts(prev => [...prev, contact]);
            document.getElementById('add_contact_modal').close(); 
            setNewContact(emptyContact); 
            showToast('Contact added!', 'success');
          } catch {
            showToast('Failed to add contact. Please try again.', 'error');
          }
        };

        const [newContact, setNewContact] = React.useState(emptyContact);

        return (
            <div className="bg-white rounded-2xl shadow-xl border border-gray-100">
                <div className="p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-semibold text-gray-800">Networking</h2>
                        <button className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors duration-200" 
                                onClick={() => document.getElementById('add_contact_modal').showModal()}>
                            <Icon name="plus" className="w-4 h-4"/> Add Contact
                        </button>
                    </div>
                    {contacts.length === 0 ? (
                        <div className="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                            <Icon name="users" className="w-16 h-16 mx-auto text-gray-300" />
                            <p className="mt-4 text-xl font-semibold text-gray-600">No contacts yet</p>
                            <p className="text-sm text-gray-500 mt-1">Start building your professional network</p>
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-gray-200">
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'20%'}}>Name</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'20%'}}>Company</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'20%'}}>Role</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'15%'}}>Contact Date</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm">Notes</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'5%'}}></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {contacts.map((c) => (
                                        <tr key={c.id} className="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Name} onChange={e => updateContact(c.id, 'Name', e.target.value)} placeholder="Name" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Company} onChange={e => updateContact(c.id, 'Company', e.target.value)} placeholder="Company" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Role} onChange={e => updateContact(c.id, 'Role', e.target.value)} placeholder="Role" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="date" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.ContactDate} onChange={e => updateContact(c.id, 'ContactDate', e.target.value)} />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Notes} onChange={e => updateContact(c.id, 'Notes', e.target.value)} placeholder="Notes" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <button className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors duration-150" 
                                                        onClick={()=>deleteContact(c.id)}>
                                                    <Icon name="trash-2" className="w-4 h-4"/>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
                <Modal id="add_contact_modal" title="Add New Contact">
                    <div className="space-y-4">
                        <input type="text" placeholder="Name" className="input input-bordered w-full" 
                               value={newContact.Name} onChange={e => setNewContact({...newContact, Name: e.target.value})} />
                        <input type="text" placeholder="Company" className="input input-bordered w-full" 
                               value={newContact.Company} onChange={e => setNewContact({...newContact, Company: e.target.value})} />
                        <input type="text" placeholder="Role" className="input input-bordered w-full" 
                               value={newContact.Role} onChange={e => setNewContact({...newContact, Role: e.target.value})} />
                        <input type="date" className="input input-bordered w-full" 
                               value={newContact.ContactDate} onChange={e => setNewContact({...newContact, ContactDate: e.target.value})} />
                        <textarea className="textarea textarea-bordered w-full" placeholder="Notes" 
                                  value={newContact.Notes} onChange={e => setNewContact({...newContact, Notes: e.target.value})}></textarea>
                        <div className="modal-action">
                            <button type="button" className="btn" onClick={() => document.getElementById('add_contact_modal').close()}>Cancel</button>
                            <button type="button" className="btn btn-primary" onClick={() => addContact({...newContact, id: `contact-${Date.now()}`})}>Save</button>
                        </div>
                    </div>
                </Modal>
            </div>
        );
    }
    
    function App() {
      const { user, loading: authLoading, signOut } = useAuth();
      const { jobs, contacts, loading: dataLoading, updateJobs, updateContacts, loadUserData } = useFirebaseData(user);
      const [jobSearchTerm, setJobSearchTerm] = React.useState('');
      const [contactSearchTerm, setContactSearchTerm] = React.useState('');
      const [statusFilters, setStatusFilters] = React.useState([]);
      const [jobTypeFilters, setJobTypeFilters] = React.useState([]);
      const [sourceFilters, setSourceFilters] = React.useState([]);
      const [locationFilter, setLocationFilter] = React.useState('');
      const [showAdvancedFilters, setShowAdvancedFilters] = React.useState(false);
      const [selectedMetricFilters, setSelectedMetricFilters] = React.useState([]);
      const [newJob, setNewJob] = React.useState(emptyJob);

      const filteredJobs = React.useMemo(() => {
        let filtered = jobs;
        
        // Apply metric-based filters if any are selected
        if (selectedMetricFilters.length > 0) {
          filtered = filtered.filter(job => {
            return selectedMetricFilters.some(filter => {
              switch(filter) {
                case 'offers':
                  return ["Offer Received", "Offer Accepted"].includes(job.Status);
                case 'rejected':
                  return job.Status === "Rejected";
                case 'inProgress':
                  return ["Applied", "HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview"].includes(job.Status);
                case 'total':
                  return true; // All jobs
                default:
                  return false;
              }
            });
          });
        }
        
        return filtered
          .filter(job => statusFilters.length === 0 || statusFilters.includes(job.Status))
          .filter(job => jobTypeFilters.length === 0 || jobTypeFilters.includes(job.JobType))
          .filter(job => sourceFilters.length === 0 || sourceFilters.includes(job.Source))
          .filter(job => locationFilter === '' || job.Location.toLowerCase().includes(locationFilter.toLowerCase()))
          .filter(job => jobSearchTerm === '' || 
            job.Company.toLowerCase().includes(jobSearchTerm.toLowerCase()) || 
            job.Title.toLowerCase().includes(jobSearchTerm.toLowerCase()) ||
            job.NextStep.toLowerCase().includes(jobSearchTerm.toLowerCase())
          );
      }, [jobs, selectedMetricFilters, statusFilters, jobTypeFilters, sourceFilters, locationFilter, jobSearchTerm]);

      const filteredContacts = React.useMemo(() => {
        return contacts.filter(contact => 
          contactSearchTerm === '' || 
          contact.Name.toLowerCase().includes(contactSearchTerm.toLowerCase()) || 
          contact.Company.toLowerCase().includes(contactSearchTerm.toLowerCase()) ||
          contact.Role.toLowerCase().includes(contactSearchTerm.toLowerCase())
        );
      }, [contacts, contactSearchTerm]);

      const handleSaveNewJob = async (job) => {
        try {
          await updateJobs(prev => [job, ...prev]);
          document.getElementById('add_job_modal').close();
          setNewJob(emptyJob);
          showToast('Application added!', 'success');
        } catch (error) {
          showToast('Failed to save application. Please try again.', 'error');
        }
      };

      // Show loading screen while authenticating
      if (authLoading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-center">
              <div className="bg-blue-500 p-4 rounded-2xl w-16 h-16 mx-auto mb-4 animate-pulse">
                <Icon name="briefcase" className="w-8 h-8 text-white"/>
              </div>
              <div className="text-xl font-semibold text-gray-700">Loading CareerFlow...</div>
            </div>
          </div>
        );
      }

      // Show auth screen if not logged in
      if (!user) {
        return <AuthScreen />;
      }

      const handleMetricFilterToggle = (filterType) => {
        if (filterType === 'total') {
          // Clear all filters when Total Apps is clicked
          clearAllFilters();
        } else {
          setSelectedMetricFilters(prev => {
            if (prev.includes(filterType)) {
              return prev.filter(f => f !== filterType);
            } else {
              return [...prev, filterType];
            }
          });
        }
      };

      const handleFilterToggle = (filterType, value) => {
        if (filterType === 'status') {
          setStatusFilters(prev => 
            prev.includes(value) 
              ? prev.filter(f => f !== value)
              : [...prev, value]
          );
        } else if (filterType === 'jobType') {
          setJobTypeFilters(prev => 
            prev.includes(value) 
              ? prev.filter(f => f !== value)
              : [...prev, value]
          );
        } else if (filterType === 'source') {
          setSourceFilters(prev => 
            prev.includes(value) 
              ? prev.filter(f => f !== value)
              : [...prev, value]
          );
        }
      };

      const clearAllFilters = () => {
        setSelectedMetricFilters([]);
        setStatusFilters([]);
        setJobTypeFilters([]);
        setSourceFilters([]);
        setLocationFilter('');
        setJobSearchTerm('');
      };

      const hasActiveFilters = selectedMetricFilters.length > 0 || statusFilters.length > 0 || jobTypeFilters.length > 0 || sourceFilters.length > 0 || locationFilter !== '' || jobSearchTerm !== '';

      const handleDataAction = async (action) => {
        try {
          if (action === 'export') { 
            document.getElementById('export_data_modal').showModal();
          } 
          else if (action === 'import') { 
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            
            input.onchange = async (e) => {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                  try {
                    const data = JSON.parse(e.target.result);
                    let importedJobs = 0, importedContacts = 0;
                    
                    if (data.jobs && Array.isArray(data.jobs)) {
                      await updateJobs(data.jobs);
                      importedJobs = data.jobs.length;
                    }
                    if (data.contacts && Array.isArray(data.contacts)) {
                      await updateContacts(data.contacts);
                      importedContacts = data.contacts.length;
                    }
                    
                    if (importedJobs > 0 || importedContacts > 0) {
                      showToast(`Successfully imported ${importedJobs} applications and ${importedContacts} contacts!`, 'success');
                    } else {
                      showToast('No valid data found in the file.', 'info');
                    }
                  } catch (error) {
                    showToast('Error: Invalid file format. Please select a valid CareerFlow backup file.', 'error');
                  }
                };
                reader.readAsText(file);
              }
            };
            
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
          }
          else if (action === 'restore_dummy') {
              if (confirm('This will replace all your current data with sample data. Are you sure?')) {
                  await updateJobs(sampleJobs);
                  await updateContacts(sampleContacts);
                  showToast('Sample data loaded successfully!', 'success');
              }
          }
          else if (action === 'reset') {
              if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
                  await updateJobs([]);
                  await updateContacts([]);
                  showToast('All data has been cleared.', 'info');
              }
          }
        } catch (error) {
          console.error('Data action error:', error);
          showToast('An error occurred. Please try again.', 'error');
        }
      };

      return (
        <div className="space-y-8 bg-gray-50 min-h-screen">
            <div className="bg-white shadow-lg border-b border-gray-200 sticky top-0 z-10">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex justify-between items-center py-4">
                  <div className="flex items-center gap-3">
                    <div className="bg-blue-500 p-2 rounded-lg">
                      <Icon name="briefcase" className="w-6 h-6 text-white"/>
                    </div>
                    <h1 className="text-2xl font-bold text-gray-900">CareerFlow</h1>
                  </div>
                  <div className="flex items-center gap-3">
                    {dataLoading && (
                      <div className="flex items-center gap-2 text-sm text-gray-600">
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
                        Syncing...
                      </div>
                    )}
                    <div className="dropdown dropdown-end">
                      <div tabIndex={0} role="button" className="btn btn-ghost btn-circle hover:bg-gray-100">
                        <Icon name="settings" className="w-5 h-5"/>
                      </div>
                      <ul tabIndex={0} className="menu menu-sm dropdown-content mt-3 z-[10] p-2 shadow-lg bg-white rounded-xl border border-gray-200 w-56">
                        <li><a onClick={() => handleDataAction('export')} className="text-blue-600 hover:bg-blue-50"><Icon name="download" className="w-4 h-4"/> Export Data</a></li>
                        <li><a onClick={() => handleDataAction('import')} className="text-green-600 hover:bg-green-50"><Icon name="upload" className="w-4 h-4"/> Import Data</a></li>
                        <li><hr className="my-1"/></li>
                        <li><a onClick={() => document.getElementById('email_templates_modal').showModal()} className="text-purple-600 hover:bg-purple-50"><Icon name="mail" className="w-4 h-4"/> Email Templates</a></li>
                        <li><hr className="my-1"/></li>
                        <li><a onClick={() => handleDataAction('restore_dummy')} className="text-purple-600 hover:bg-purple-50"><Icon name="refresh-cw" className="w-4 h-4"/> Load Sample Data</a></li>
                        <li><hr className="my-1"/></li>
                        <li><a onClick={() => handleDataAction('reset')} className="text-red-600 hover:bg-red-50"><Icon name="trash" className="w-4 h-4"/> Clear All Data</a></li>
                      </ul>
                    </div>
                    <UserProfile user={user} onSignOut={signOut} />
                  </div>
                </div>
              </div>
            </div>

            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
              <Analytics jobs={jobs} selectedMetricFilters={selectedMetricFilters} onMetricFilterToggle={handleMetricFilterToggle} />
              
              <div className="space-y-6">
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                  <div className="flex justify-between items-center mb-4">
                      <h2 className="text-2xl font-bold text-gray-900">Job Applications</h2>
                      <button className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors duration-200" 
                              onClick={() => document.getElementById('add_job_modal').showModal()}>
                          <Icon name="plus" className="w-5 h-5"/> New Application
                      </button>
                  </div>
                  
                  <div className="space-y-4">
                    <div className="flex flex-wrap items-center gap-4">
                      <input type="text" placeholder="Search by company, title, or notes..." 
                             className="flex-1 min-w-64 px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                             onChange={e => setJobSearchTerm(e.target.value)} />
                      <button 
                        className="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg border border-blue-200 text-sm flex items-center gap-2 transition-colors duration-200"
                        onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
                      >
                        <Icon name="filter" className="w-4 h-4"/>
                        {showAdvancedFilters ? 'Hide Filters' : 'Advanced Filters'}
                      </button>
                    </div>
                    
                    {showAdvancedFilters && (
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-2">Status ({statusFilters.length} selected)</label>
                          <div className="space-y-1 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-white">
                            {statusList.map(status => (
                              <label key={status} className="flex items-center space-x-2 text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                <input 
                                  type="checkbox" 
                                  checked={statusFilters.includes(status)}
                                  onChange={() => handleFilterToggle('status', status)}
                                  className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                />
                                <span className="text-gray-700">{status}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                        
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-2">Job Type ({jobTypeFilters.length} selected)</label>
                          <div className="space-y-1 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-white">
                            {jobTypeList.map(type => (
                              <label key={type} className="flex items-center space-x-2 text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                <input 
                                  type="checkbox" 
                                  checked={jobTypeFilters.includes(type)}
                                  onChange={() => handleFilterToggle('jobType', type)}
                                  className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                />
                                <span className="text-gray-700">{type}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                        
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-2">Source ({sourceFilters.length} selected)</label>
                          <div className="space-y-1 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-white">
                            {sourceList.map(source => (
                              <label key={source} className="flex items-center space-x-2 text-sm hover:bg-gray-50 p-1 rounded cursor-pointer">
                                <input 
                                  type="checkbox" 
                                  checked={sourceFilters.includes(source)}
                                  onChange={() => handleFilterToggle('source', source)}
                                  className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                />
                                <span className="text-gray-700">{source}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                        
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-2">Location</label>
                          <input type="text" placeholder="Filter by location..." 
                                 className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                 value={locationFilter} onChange={e => setLocationFilter(e.target.value)} />
                        </div>
                      </div>
                    )}
                    
                    {hasActiveFilters && (
                      <div className="flex items-center gap-2 flex-wrap">
                        <span className="text-sm text-gray-600">Active filters:</span>
                        {selectedMetricFilters.map(filter => {
                          const labels = { total: 'All Applications', inProgress: 'In Progress', offers: 'Offers', rejected: 'Rejected' };
                          const colors = { total: 'bg-blue-100 text-blue-800', inProgress: 'bg-amber-100 text-amber-800', offers: 'bg-emerald-100 text-emerald-800', rejected: 'bg-red-100 text-red-800' };
                          return <span key={filter} className={`px-2 py-1 text-xs rounded-full ${colors[filter]}`}>{labels[filter]}</span>;
                        })}
                        {statusFilters.map(status => 
                          <span key={status} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Status: {status}</span>
                        )}
                        {jobTypeFilters.map(type => 
                          <span key={type} className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Type: {type}</span>
                        )}
                        {sourceFilters.map(source => 
                          <span key={source} className="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">Source: {source}</span>
                        )}
                        {locationFilter !== '' && <span className="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Location: {locationFilter}</span>}
                        {jobSearchTerm !== '' && <span className="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">Search: "{jobSearchTerm}"</span>}
                        <button 
                          className="text-xs text-red-600 hover:text-red-800 ml-2"
                          onClick={clearAllFilters}
                        >
                          Clear all
                        </button>
                      </div>
                    )}
                  </div>
                </div>
                
                <div className="bg-white rounded-xl shadow-sm border border-gray-100">
                  <div className="p-4 border-b border-gray-100">
                    <div className="flex items-center justify-between">
                      <div className="text-sm text-gray-600">
                        Showing {filteredJobs.length} of {jobs.length} applications
                      </div>
                      {filteredJobs.length !== jobs.length && (
                        <div className="text-xs text-blue-600">
                          {jobs.length - filteredJobs.length} applications filtered out
                        </div>
                      )}
                    </div>
                  </div>
                  <TrackerTable jobs={filteredJobs} setJobs={updateJobs} />
                </div>
                
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                  <div className="flex justify-between items-center mb-4">
                      <h2 className="text-2xl font-bold text-gray-900">Networking</h2>
                      <input type="text" placeholder="Search contacts by name, company, or role..." 
                             className="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-80" 
                             onChange={e => setContactSearchTerm(e.target.value)} />
                  </div>
                  {filteredContacts.length !== contacts.length && (
                    <div className="mb-4 text-sm text-gray-600">
                      Showing {filteredContacts.length} of {contacts.length} contacts
                    </div>
                  )}
                  <ContactsTable contacts={filteredContacts} setContacts={updateContacts} />
                </div>
              </div>
            </div>
            
            <Modal id="add_job_modal" title="Add New Job Application">
              <JobForm jobData={newJob} onSave={handleSaveNewJob} onCancel={() => document.getElementById('add_job_modal').close()} />
            </Modal>
            
            <Modal id="export_data_modal" title="Export Your Data">
              <ExportModal 
                onCancel={() => document.getElementById('export_data_modal').close()} 
                jobs={jobs} 
                contacts={contacts} 
              />
            </Modal>

            <Modal id="email_templates_modal" title="Email Templates">
              <EmailTemplatesModal onCancel={() => document.getElementById('email_templates_modal').close()} />
            </Modal>
        </div>
      );
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>