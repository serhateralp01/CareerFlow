<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>CareerFlow - Professional Application Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAIQSURBVEhL7ZRLSwNBEIb/RCyIWEREEAQfElAREfFNEf+CAmJBiIgIIgiCIIgISyAiiSAgCOJ/AsElHyAie6e3s7OOKzV5EFy4qeqq6Z6e3tkdMMZ/zF+bOPk+kE3G8ryJ2F+9s5wfJ9a0lAA4wA1m6jAD45l6gKkPAzYAG8Mg1uKAXwA9sUuO5YqD2Fm2VCDA1V4C1sUan4gWw4FG2ZgA7Iq7f/41Yl4k2gVzPoclhO/kO4l2AzsW4p2pY3jS2w2PcPqA7dI1h4aLwGnwhk1nCg8I+pLiXGfAB43V1BfAk41XlBfD5rmoLsDKerDQmYlAMMRd2cAi3wBf/gXo2/kNmGisfsNwz4E2eDYOtl2fXQ1W7bI0j4Q0YyA2zCLwA8+lsuGSx1t1wZ/gTqfIN2Nl2eXwA+BGn8jYnlYB5xSg/T+E2b/43ge3bAsws7oBCpUn885wc13aY5k2g8T2YIny2kQ2QG0h1hA9Uxx8gK0n6L1u9NBzcjxijrgrwY8Y5wVe1n4C52g1gNOzQkTsSHq5z4jPMR4NnTPpIGu+17L44wLgAbY5vAJ5E3851G7j8sgaMPg2gSg2gSg2gSg3gC4p7wAjw+q5qC/Ak41XlBfD5rmoLsDKerDQmYlAMMRd2cAi3wBf/gXo2/kNmGisfsNwzYJPwXg3sZDcGSx1t1wZ/gTqfIN2Nl2eXwA+BGn8jYn1YBy4+UJT/sAxz+MKL/xrFvG3hA/j9AdB7Xl2uVwJb/KEbEyHagxQXs2OC1QE0yDEr9wqun2eZBtC430GvNOLe8l8gvgt9pA9Uxx8gK0n6L1u9NBzcjxijrgrwY8Y5wVe1n4C52g1gNOzQkTsSHq5z4jPMR4NnTPpIGu+17L44wLgAbY5vAJ5E3851G7j8sgaMPg2gSg2gSg2gSg3gC4p7wAjw+q5qC/Ak41XlBfD5rmoLsDKerDQmYlAMMRd2cAi3wBf/gXo2/kNmGisfsNwzYJPwXg3sZDcGSx1t1wZ/gTqfIN2Nl2eXwA+BGn8jYn1YBy4+UJT/sAxz+MKL/xolx2uM3wJj/PPgfzRI0VnBAi10AAAAASUVORK5CYII=">
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.11.1/dist/full.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBmc11Cf_-op_e2HikOKhx2zhlUKN51aew",
      authDomain: "careerflow-app.firebaseapp.com",
      projectId: "careerflow-app",
      storageBucket: "careerflow-app.firebasestorage.app",
      messagingSenderId: "616353508218",
      appId: "1:616353508218:web:f9ca9d3d028fd6b7b484c3",
      measurementId: "G-V8RW33STR9"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    // Make Firebase services available globally
    window.firebase = {
      auth: auth,
      db: db,
      provider: provider,
      signInWithPopup: auth.signInWithPopup.bind(auth),
      signOut: auth.signOut.bind(auth),
      onAuthStateChanged: auth.onAuthStateChanged.bind(auth),
      collection: db.collection.bind(db),
      doc: db.doc.bind(db),
      setDoc: (docRef, data) => docRef.set(data),
      getDoc: (docRef) => docRef.get(),
      getDocs: (query) => query.get(),
      deleteDoc: (docRef) => docRef.delete(),
      onSnapshot: (query, callback) => query.onSnapshot(callback),
      serverTimestamp: firebase.firestore.FieldValue.serverTimestamp
    };
  </script>
</head>
<body class="bg-base-200 min-h-screen font-sans">
  
  <main id="root" class="container mx-auto p-4 md:p-6"></main>
  <div id="toast-container" class="toast toast-bottom toast-end z-50"></div>

  <script type="text/babel">
    /********* Injected data & Config *********/
    const statusList = ["Wishlist", "To Apply", "Applied", "HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview", "Offer Received", "Offer Accepted", "Rejected", "Withdrawn"];
    const jobTypeList = ["Internship", "Full-Time", "Part-Time", "Thesis Project"];
    const sourceList  = ["Polimi CareerService", "LinkedIn", "Company Website", "Referral", "Networking Event", "Other"];
    const DOUGHNUT_COLORS = { Offers: '#22C55E', Rejected: '#EF4444', 'In-Progress': '#F59E0B', Other: '#8B5CF6' };
    const KANBAN_COLUMNS = ["Backlog", "Applied", "HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview", "Offer Received"];

    const getTodayPlusDays = (days) => new Date(new Date().setDate(new Date().getDate() + days)).toISOString().split('T')[0];
    const sampleJobs  = [
      { id: "job-1", Status: "Case Study / Assessment", Company: "Bain & Company", Title: "Associate Consultant Intern", JobType: "Internship", Location: "Milan", Source: "Polimi CareerService", AppDeadline: getTodayPlusDays(2), DateApplied: "2025-04-10", NextStep: "Prepare case study for Friday" },
      { id: "job-2", Status: "Applied", Company: "Google", Title: "Business Analyst", JobType: "Thesis Project", Location: "Berlin", Source: "Company Website", AppDeadline: getTodayPlusDays(30), DateApplied: "2025-04-06", NextStep: "Follow up next week" },
      { id: "job-3", Status: "HR Screening", Company: "Ferrari", Title: "Mechanical Engineer", JobType: "Full-Time", Location: "Maranello", Source: "LinkedIn", AppDeadline: getTodayPlusDays(6), DateApplied: "2025-05-18", NextStep: "HR call scheduled for tomorrow" },
      { id: "job-4", Status: "Offer Accepted", Company: "Enel", Title: "Data Scientist", JobType: "Full-Time", Location: "Remote", Source: "Referral", AppDeadline: "2025-03-16", DateApplied: "2025-03-27", NextStep: "Contract signed, onboarding starts 01/09" },
      { id: "job-5", Status: "Rejected", Company: "Nestlé", Title: "Supply Chain Intern", JobType: "Internship", Location: "Dublin", Source: "Networking Event", AppDeadline: "2025-02-23", DateApplied: "2025-03-21", NextStep: "Rejected after final interview" },
      { id: "job-6", Status: "Technical Interview", Company: "Amazon", Title: "Cloud Support Associate", JobType: "Internship", Location: "Dublin", Source: "Company Website", AppDeadline: getTodayPlusDays(-5), DateApplied: "2025-04-19", NextStep: "Waiting for feedback" },
      { id: "job-7", Status: "Wishlist", Company: "McKinsey & Co", Title: "Business Analyst Intern", JobType: "Internship", Location: "Milan", Source: "Networking Event", AppDeadline: getTodayPlusDays(90), DateApplied: "", NextStep: "Network with alumni" },
      { id: "job-8", Status: "Offer Received", Company: "Pirelli", Title: "Junior PMO", JobType: "Full-Time", Location: "Milan", Source: "Other", AppDeadline: getTodayPlusDays(25), DateApplied: "2025-03-22", NextStep: "Negotiate salary" },
    ];
    const sampleContacts = [
      { id: "contact-1", Name: "Mario Rossi", Company: "McKinsey & Co", Role: "Engagement Manager", ContactDate: "2025-05-29", Notes: "Referral for internship" },
      { id: "contact-2", Name: "Giulia Bianchi", Company: "Google", Role: "Recruiter", ContactDate: "2025-05-22", Notes: "Coffee chat, very helpful" },
    ];

    /********* Firebase Services *********/
    const FirebaseService = {
      async saveJobs(userId, jobs) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('jobs');
          await docRef.set({
            jobs: jobs,
            lastUpdated: window.firebase.serverTimestamp()
          });
        } catch (error) {
          console.error('Error saving jobs:', error);
          throw error;
        }
      },

      async loadJobs(userId) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('jobs');
          const docSnap = await docRef.get();
          if (docSnap.exists) {
            return docSnap.data().jobs || [];
          }
          return [];
        } catch (error) {
          console.error('Error loading jobs:', error);
          return [];
        }
      },

      async saveContacts(userId, contacts) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('contacts');
          await docRef.set({
            contacts: contacts,
            lastUpdated: window.firebase.serverTimestamp()
          });
        } catch (error) {
          console.error('Error saving contacts:', error);
          throw error;
        }
      },

      async loadContacts(userId) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('contacts');
          const docSnap = await docRef.get();
          if (docSnap.exists) {
            return docSnap.data().contacts || [];
          }
          return [];
        } catch (error) {
          console.error('Error loading contacts:', error);
          return [];
        }
      }
    };

    /********* Helpers & Custom Hooks *********/
    const emptyJob = { Status:"Wishlist", Company:"", Title:"", JobType:"Internship", Location:"", Source:"Polimi CareerService", AppDeadline:"", DateApplied:"", NextStep:"" };
    const emptyContact = { Name:"", Company:"", Role:"", ContactDate:"", Notes:"" };

    function useAuth() {
      const [user, setUser] = React.useState(null);
      const [loading, setLoading] = React.useState(true);

      React.useEffect(() => {
        const unsubscribe = window.firebase.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      const signIn = async () => {
        try {
          await window.firebase.signInWithPopup(window.firebase.provider);
          showToast('Successfully signed in!', 'success');
        } catch (error) {
          console.error('Sign in error:', error);
          showToast('Failed to sign in. Please try again.', 'error');
        }
      };

      const signOut = async () => {
        try {
          await window.firebase.signOut();
          showToast('Successfully signed out!', 'info');
        } catch (error) {
          console.error('Sign out error:', error);
          showToast('Failed to sign out.', 'error');
        }
      };

      return { user, loading, signIn, signOut };
    }

    function useFirebaseData(user) {
      const [jobs, setJobs] = React.useState([]);
      const [contacts, setContacts] = React.useState([]);
      const [loading, setLoading] = React.useState(true);

      // Load data when user changes
      React.useEffect(() => {
        if (user) {
          loadUserData();
        } else {
          setJobs([]);
          setContacts([]);
          setLoading(false);
        }
      }, [user]);

      const loadUserData = async () => {
        if (!user) return;
        
        setLoading(true);
        try {
          const [jobsData, contactsData] = await Promise.all([
            FirebaseService.loadJobs(user.uid),
            FirebaseService.loadContacts(user.uid)
          ]);
          setJobs(jobsData);
          setContacts(contactsData);
        } catch (error) {
          console.error('Error loading user data:', error);
          showToast('Failed to load your data.', 'error');
        }
        setLoading(false);
      };

      const updateJobs = async (newJobs) => {
        if (!user) return;
        
        setJobs(newJobs);
        try {
          await FirebaseService.saveJobs(user.uid, newJobs);
        } catch (error) {
          console.error('Error saving jobs:', error);
          showToast('Failed to save jobs. Changes may be lost.', 'error');
        }
      };

      const updateContacts = async (newContacts) => {
        if (!user) return;
        
        setContacts(newContacts);
        try {
          await FirebaseService.saveContacts(user.uid, newContacts);
        } catch (error) {
          console.error('Error saving contacts:', error);
          showToast('Failed to save contacts. Changes may be lost.', 'error');
        }
      };

      return { jobs, contacts, loading, updateJobs, updateContacts, loadUserData };
    }

    function useLocalStorage(key, initialValue) {
      const [storedValue, setStoredValue] = React.useState(() => {
        try { const item = window.localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; } 
        catch (error) { return initialValue; }
      });
      const setValue = (value) => {
        try {
          const valueToStore = value instanceof Function ? value(storedValue) : value;
          setStoredValue(valueToStore);
          window.localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (error) { console.error(error); }
      };
      return [storedValue, setValue];
    }
    
    const showToast = (message, type = 'success') => {
        const toastContainer = document.getElementById('toast-container');
        const toastId = `toast-${Date.now()}`;
        const alertClass = { success: 'alert-success', error: 'alert-error', info: 'alert-info' }[type];
        const toastElement = document.createElement('div');
        toastElement.id = toastId;
        toastElement.className = `alert ${alertClass} shadow-lg`;
        toastElement.innerHTML = `<span>${message}</span>`;
        toastContainer.appendChild(toastElement);
        setTimeout(() => { toastElement.remove() }, 3000);
    };

    const getDeadlineClass = (deadline) => {
      if (!deadline) return '';
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const deadlineDate = new Date(deadline);
      const diffDays = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
      if (diffDays <= 0) return 'text-error font-bold';
      if (diffDays <= 3) return 'text-warning font-bold';
      if (diffDays <= 7) return 'text-success font-bold';
      return '';
    };

    /********* Reusable Components *********/
    function Icon({ name, className = "w-5 h-5" }) {
        return <span className="inline-block" dangerouslySetInnerHTML={{ __html: feather.icons[name].toSvg({ class: className }) }} />;
    }

    function Modal({ id, title, children }) {
        return (
            <dialog id={id} className="modal">
                <div className="modal-box w-11/12 max-w-2xl"><form method="dialog"><button className="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form><h3 className="font-bold text-lg mb-4">{title}</h3>{children}</div>
                <form method="dialog" className="modal-backdrop"><button>close</button></form>
            </dialog>
        );
    }
    
    function ChartComponent({ chartId, type, data, options }) {
      const chartRef = React.useRef(null);
      React.useEffect(() => {
        const ctx = document.getElementById(chartId).getContext('2d');
        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(ctx, { type, data, options });
        return () => chartRef.current?.destroy();
      }, [data]);
      return <canvas id={chartId} style={{maxHeight: '220px'}}></canvas>;
    }

    /********* Auth Components *********/
    function AuthScreen() {
      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <div className="bg-blue-500 p-4 rounded-2xl w-16 h-16 mx-auto mb-4">
                <Icon name="briefcase" className="w-8 h-8 text-white"/>
              </div>
              <h1 className="text-3xl font-bold text-gray-900 mb-2">CareerFlow</h1>
              <p className="text-gray-600">Professional Application Tracker</p>
            </div>
            
            <div className="space-y-6">
              <div className="text-center">
                <h2 className="text-xl font-semibold text-gray-800 mb-2">Welcome Back</h2>
                <p className="text-gray-600 text-sm">Sign in to access your job application data</p>
              </div>
              
              <AuthButton />
              
              <div className="text-center text-xs text-gray-500">
                <p>Your data is securely stored in Firebase</p>
                <p>and synced across all your devices</p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function AuthButton() {
      const { signIn } = useAuth();
      
      return (
        <button 
          onClick={signIn}
          className="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 flex items-center justify-center gap-3 hover:bg-gray-50 transition-colors duration-200 shadow-sm"
        >
          <svg className="w-5 h-5" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Continue with Google
        </button>
      );
    }

    function UserProfile({ user, onSignOut }) {
      return (
        <div className="dropdown dropdown-end">
          <div tabIndex={0} role="button" className="btn btn-ghost btn-circle avatar">
            <div className="w-8 rounded-full">
              <img src={user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=3b82f6&color=fff`} alt="Profile" />
            </div>
          </div>
          <ul tabIndex={0} className="menu menu-sm dropdown-content mt-3 z-[10] p-2 shadow-lg bg-white rounded-xl border border-gray-200 w-64">
            <li className="p-2 border-b border-gray-100">
              <div className="flex flex-col">
                <span className="font-medium text-gray-900">{user.displayName || 'User'}</span>
                <span className="text-xs text-gray-500">{user.email}</span>
              </div>
            </li>
            <li><a onClick={onSignOut} className="text-red-600 hover:bg-red-50"><Icon name="log-out" className="w-4 h-4"/> Sign Out</a></li>
          </ul>
        </div>
      );
    }
    
    /********* Main Components *********/
    function Analytics({ jobs, selectedMetricFilters, onMetricFilterToggle }) {
      const metrics = React.useMemo(() => {
        return jobs.reduce((acc, job) => {
          acc.total++;
          if (["Offer Received", "Offer Accepted"].includes(job.Status)) acc.offers++;
          else if (job.Status === "Rejected") acc.rejected++;
          else if (["Applied", "HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview"].includes(job.Status)) acc.inProgress++;
          return acc;
        }, { total: 0, offers: 0, rejected: 0, inProgress: 0 });
      }, [jobs]);

      const timelineData = React.useMemo(() => {
        // Group applications by month for timeline
        const monthlyData = {};
        const today = new Date();
        
        // Initialize last 6 months
        for (let i = 5; i >= 0; i--) {
          const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
          const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          monthlyData[monthKey] = { applied: 0, offers: 0, rejected: 0 };
        }
        
        jobs.forEach(job => {
          if (job.DateApplied) {
            const appDate = new Date(job.DateApplied);
            const monthKey = appDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            
            if (monthlyData[monthKey]) {
              monthlyData[monthKey].applied++;
              if (["Offer Received", "Offer Accepted"].includes(job.Status)) {
                monthlyData[monthKey].offers++;
              } else if (job.Status === "Rejected") {
                monthlyData[monthKey].rejected++;
              }
            }
          }
        });

        const labels = Object.keys(monthlyData);
        const appliedData = Object.values(monthlyData).map(m => m.applied);
        const offersData = Object.values(monthlyData).map(m => m.offers);
        const rejectedData = Object.values(monthlyData).map(m => m.rejected);

        return {
          labels,
          datasets: [
            {
              label: 'Applications',
              data: appliedData,
              borderColor: '#3B82F6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#3B82F6',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8,
            },
            {
              label: 'Offers',
              data: offersData,
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#10B981',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8,
            },
            {
              label: 'Rejections',
              data: rejectedData,
              borderColor: '#EF4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#EF4444',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8,
            }
          ]
        };
      }, [jobs]);

      const doughnutData = {
        labels: ['Offers', 'Rejected', 'In-Progress', 'Other'],
        datasets: [{
          data: [metrics.offers, metrics.rejected, metrics.inProgress, metrics.total - metrics.offers - metrics.rejected - metrics.inProgress],
          backgroundColor: ['#10B981', '#EF4444', '#F59E0B', '#8B5CF6'],
          borderWidth: 0,
          borderRadius: 8,
          spacing: 2,
        }]
      };
      
      const barData = {
        labels: statusList,
        datasets: [{
          label: 'Applications',
          data: statusList.map(s => jobs.filter(j => j.Status === s).length),
          backgroundColor: statusList.map((_, i) => {
            const colors = ['#8B5CF6', '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1', '#14B8A6'];
            return colors[i % colors.length];
          }),
          borderRadius: 4,
          borderSkipped: false,
        }]
      };

      return (
        <div className="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl border border-gray-100">
          <div className="p-6 space-y-6">
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className={`bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 ${
                    selectedMetricFilters.includes('total') ? 'border-blue-400 ring-2 ring-blue-200 shadow-lg' : 'border-blue-200/50 hover:shadow-md'
                  }`} onClick={() => onMetricFilterToggle('total')}>
                    <div className="text-xs font-medium text-blue-600 uppercase tracking-wide">Total Apps</div>
                    <div className="text-2xl font-bold text-blue-700 mt-1 flex items-center justify-center gap-2">
                      {metrics.total} <Icon name="layers" className="w-5 h-5"/>
                    </div>
                    {selectedMetricFilters.includes('total') && (
                      <div className="mt-2"><span className="inline-block w-2 h-2 bg-blue-500 rounded-full"></span></div>
                    )}
                  </div>
                  <div className={`bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 ${
                    selectedMetricFilters.includes('inProgress') ? 'border-amber-400 ring-2 ring-amber-200 shadow-lg' : 'border-amber-200/50 hover:shadow-md'
                  }`} onClick={() => onMetricFilterToggle('inProgress')}>
                    <div className="text-xs font-medium text-amber-600 uppercase tracking-wide">In Progress</div>
                    <div className="text-2xl font-bold text-amber-700 mt-1 flex items-center justify-center gap-2">
                      {metrics.inProgress} <Icon name="clock" className="w-5 h-5"/>
                    </div>
                    {selectedMetricFilters.includes('inProgress') && (
                      <div className="mt-2"><span className="inline-block w-2 h-2 bg-amber-500 rounded-full"></span></div>
                    )}
                  </div>
                  <div className={`bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 ${
                    selectedMetricFilters.includes('offers') ? 'border-emerald-400 ring-2 ring-emerald-200 shadow-lg' : 'border-emerald-200/50 hover:shadow-md'
                  }`} onClick={() => onMetricFilterToggle('offers')}>
                    <div className="text-xs font-medium text-emerald-600 uppercase tracking-wide">Offers</div>
                    <div className="text-2xl font-bold text-emerald-700 mt-1 flex items-center justify-center gap-2">
                      {metrics.offers} <Icon name="thumbs-up" className="w-5 h-5"/>
                    </div>
                    {selectedMetricFilters.includes('offers') && (
                      <div className="mt-2"><span className="inline-block w-2 h-2 bg-emerald-500 rounded-full"></span></div>
                    )}
                  </div>
                  <div className={`bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 ${
                    selectedMetricFilters.includes('rejected') ? 'border-red-400 ring-2 ring-red-200 shadow-lg' : 'border-red-200/50 hover:shadow-md'
                  }`} onClick={() => onMetricFilterToggle('rejected')}>
                    <div className="text-xs font-medium text-red-600 uppercase tracking-wide">Rejected</div>
                    <div className="text-2xl font-bold text-red-700 mt-1 flex items-center justify-center gap-2">
                      {metrics.rejected} <Icon name="x-circle" className="w-5 h-5"/>
                    </div>
                    {selectedMetricFilters.includes('rejected') && (
                      <div className="mt-2"><span className="inline-block w-2 h-2 bg-red-500 rounded-full"></span></div>
                    )}
                  </div>
              </div>

              {jobs.length > 0 ? (
                <div className="space-y-8">
                  <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                    <h3 className="font-semibold text-lg text-gray-800 mb-6 flex items-center gap-2">
                      <Icon name="trending-up" className="w-5 h-5 text-blue-500"/>
                      Application Timeline - Last 6 Months
                    </h3>
                    <div style={{height: '300px'}}>
                      <ChartComponent chartId="timeline-chart" type="line" data={timelineData} options={{
                        maintainAspectRatio: false,
                        responsive: true,
                        plugins: {
                          legend: {
                            display: true,
                            position: 'top',
                            labels: {
                              usePointStyle: true,
                              padding: 20,
                              font: { size: 12, weight: '500' }
                            }
                          },
                          tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(0,0,0,0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            intersect: false,
                            mode: 'index'
                          }
                        },
                        scales: {
                          x: {
                            grid: { color: '#F3F4F6', lineWidth: 1 },
                            ticks: { color: '#6B7280', font: { size: 11, weight: '500' } },
                            border: { display: false }
                          },
                          y: {
                            beginAtZero: true,
                            grid: { color: '#F3F4F6', lineWidth: 1 },
                            ticks: { 
                              stepSize: 1, 
                              color: '#6B7280', 
                              font: { size: 11 },
                              callback: function(value) { return Math.floor(value) === value ? value : ''; }
                            },
                            border: { display: false }
                          }
                        },
                        elements: {
                          line: { borderJoinStyle: 'round' },
                          point: { hoverBorderWidth: 3 }
                        },
                        interaction: {
                          intersect: false,
                          mode: 'index'
                        },
                        animation: {
                          duration: 1200,
                          easing: 'easeInOutCubic',
                          delay: (context) => context.dataIndex * 100
                        }
                      }} />
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                      <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                          <h3 className="font-semibold text-lg text-gray-800 mb-4 text-center">Pipeline Overview</h3>
                          <div className="flex justify-center mb-4">
                            <ChartComponent chartId="chart1" type="doughnut" data={doughnutData} options={{plugins:{legend:{display:false}}, cutout: '70%', maintainAspectRatio: false}} />
                          </div>
                          <div className="grid grid-cols-2 gap-3">
                            {doughnutData.labels.map((label, i) => (
                              <div key={label} className="flex items-center gap-2 text-sm bg-gray-50 rounded-lg p-2">
                                <div className="w-3 h-3 rounded-full" style={{backgroundColor: doughnutData.datasets[0].backgroundColor[i]}}></div>
                                <span className="font-medium text-gray-700">{label}</span>
                              </div>
                            ))}
                          </div>
                      </div>
                      <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                          <h3 className="font-semibold text-lg text-gray-800 mb-4">Status Distribution</h3>
                          <div style={{height: '280px'}}>
                            <ChartComponent chartId="chart2" type="bar" data={barData} options={{
                              indexAxis:'y', 
                              maintainAspectRatio: false, 
                              plugins:{
                                legend:{display:false},
                                tooltip: {
                                  backgroundColor: 'rgba(0,0,0,0.8)',
                                  titleColor: 'white',
                                  bodyColor: 'white',
                                  borderColor: 'rgba(0,0,0,0.1)',
                                  borderWidth: 1
                                }
                              }, 
                              scales:{
                                x:{
                                  beginAtZero:true, 
                                  ticks: {stepSize: 1, color: '#6B7280', font: {size: 11}}, 
                                  grid: {color: '#F3F4F6', lineWidth: 1},
                                  border: {display: false}
                                }, 
                                y:{
                                  ticks: {color: '#374151', font: {size: 11, weight: '500'}},
                                  grid: {display: false},
                                  border: {display: false}
                                }
                              },
                              elements: {bar: {borderRadius: 4}},
                              layout: {padding: {left: 10, right: 20}},
                              animation: {duration: 800, easing: 'easeInOutQuart'}
                            }} />
                          </div>
                      </div>
                  </div>
                </div>
              ) : (
                <div className="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                    <Icon name="pie-chart" className="w-16 h-16 mx-auto text-gray-300" />
                    <p className="mt-4 text-xl font-semibold text-gray-600">No data to display</p>
                    <p className="text-sm text-gray-500 mt-1">Add your first application to see analytics</p>
                </div>
              )}
          </div>
        </div>
      );
    }
    
    function JobForm({ jobData, onSave, onCancel }) {
        const [job, setJob] = React.useState(jobData);
        const handleChange = (field, value) => setJob(prev => ({ ...prev, [field]: value }));
        const handleSave = () => onSave({ ...job, id: job.id || `job-${Date.now()}` });
        
        return (
            <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><label className="form-control w-full"><div className="label"><span className="label-text">Company</span></div><input type="text" placeholder="e.g., Google" className="input input-bordered w-full" value={job.Company} onChange={e => handleChange('Company', e.target.value)} /></label><label className="form-control w-full"><div className="label"><span className="label-text">Job Title</span></div><input type="text" placeholder="e.g., Software Engineer" className="input input-bordered w-full" value={job.Title} onChange={e => handleChange('Title', e.target.value)} /></label></div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4"><label className="form-control w-full"><div className="label"><span className="label-text">Status</span></div><select className="select select-bordered" value={job.Status} onChange={e => handleChange('Status', e.target.value)}>{statusList.map(s => <option key={s}>{s}</option>)}</select></label><label className="form-control w-full"><div className="label"><span className="label-text">Job Type</span></div><select className="select select-bordered" value={job.JobType} onChange={e => handleChange('JobType', e.target.value)}>{jobTypeList.map(t => <option key={t}>{t}</option>)}</select></label><label className="form-control w-full"><div className="label"><span className="label-text">Source</span></div><select className="select select-bordered" value={job.Source} onChange={e => handleChange('Source', e.target.value)}>{sourceList.map(s => <option key={s}>{s}</option>)}</select></label></div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4"><label className="form-control w-full"><div className="label"><span className="label-text">Location</span></div><input type="text" placeholder="e.g., Milan" className="input input-bordered w-full" value={job.Location} onChange={e => handleChange('Location', e.target.value)} /></label><label className="form-control w-full"><div className="label"><span className="label-text">Application Deadline</span></div><input type="date" className="input input-bordered w-full" value={job.AppDeadline} onChange={e => handleChange('AppDeadline', e.target.value)} /></label><label className="form-control w-full"><div className="label"><span className="label-text">Date Applied</span></div><input type="date" className="input input-bordered w-full" value={job.DateApplied} onChange={e => handleChange('DateApplied', e.target.value)} /></label></div>
                <label className="form-control w-full"><div className="label"><span className="label-text">Next Step / Notes</span></div><input type="text" placeholder="e.g., Prepare for interview" className="input input-bordered w-full" value={job.NextStep} onChange={e => handleChange('NextStep', e.target.value)} /></label>
                <div className="modal-action"><button className="btn" onClick={onCancel}>Cancel</button><button className="btn btn-primary" onClick={handleSave}>Save</button></div>
            </div>
        );
    }
    
    function TrackerTable({ jobs, setJobs, searchTerm }) {
      const updateJob = (id, field, value) => setJobs(jobs.map(j => j.id === id ? { ...j, [field]: value } : j));
      const deleteJob = (id) => { if(confirm('Are you sure?')) setJobs(jobs.filter(j => j.id !== id)); };
      
      return (
        <div className="p-6">
          {jobs.length === 0 ? (
              <div className="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                <Icon name="inbox" className="w-16 h-16 mx-auto text-gray-300" />
                <p className="mt-4 text-xl font-semibold text-gray-600">No applications yet</p>
                <p className="text-sm text-gray-500 mt-1">Click "New Application" to get started</p>
              </div>
          ) : (
              <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b border-gray-200">
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '14%'}}>Status</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '16%'}}>Company</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '20%'}}>Role</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '10%'}}>Type</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '12%'}}>Source</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '10%'}}>Deadline</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '15%'}}>Next Step</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '3%'}}></th>
                      </tr>
                    </thead>
                    <tbody>
                      {jobs.map((j) => (
                        <tr key={j.id} className="border-b border-gray-100 transition-colors duration-150" 
                            onMouseOver={e => e.currentTarget.style.backgroundColor = '#F9FAFB'}
                            onMouseOut={e => e.currentTarget.style.backgroundColor = 'transparent'}>
                          <td className="py-3 px-3">
                            <select className="w-full bg-transparent border-none text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                    value={j.Status} onChange={e => updateJob(j.id, 'Status', e.target.value)}>
                              {statusList.map(s => <option key={s}>{s}</option>)}
                            </select>
                          </td>
                          <td className="py-3 px-3">
                            <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                   value={j.Company} onChange={e => updateJob(j.id, 'Company', e.target.value)} placeholder="Company" />
                          </td>
                          <td className="py-3 px-3">
                            <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                   value={j.Title} onChange={e => updateJob(j.id, 'Title', e.target.value)} placeholder="Job title" />
                          </td>
                          <td className="py-3 px-3">
                            <select className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                    value={j.JobType} onChange={e => updateJob(j.id, 'JobType', e.target.value)}>
                              {jobTypeList.map(s => <option key={s}>{s}</option>)}
                            </select>
                          </td>
                          <td className="py-3 px-3">
                            <select className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                    value={j.Source} onChange={e => updateJob(j.id, 'Source', e.target.value)}>
                              {sourceList.map(s => <option key={s}>{s}</option>)}
                            </select>
                          </td>
                          <td className={`py-3 px-3 ${getDeadlineClass(j.AppDeadline)}`}>
                            <input type="date" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                   value={j.AppDeadline} onChange={e => updateJob(j.id, 'AppDeadline', e.target.value)} />
                          </td>
                          <td className="py-3 px-3">
                            <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                   value={j.NextStep} onChange={e => updateJob(j.id, 'NextStep', e.target.value)} placeholder="Next step" />
                          </td>
                          <td className="py-3 px-3">
                            <button className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors duration-150" 
                                    onClick={() => deleteJob(j.id)}>
                              <Icon name="trash-2" className="w-4 h-4" />
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
          )}
        </div>
      );
    }
    
    function ContactsTable({ contacts, setContacts, searchTerm }) {
        const updateContact = (id, field, value) => setContacts(contacts.map(c => c.id === id ? { ...c, [field]: value } : c));
        const deleteContact = (id) => { if(confirm('Are you sure?')) setContacts(contacts.filter(c => c.id !== id)); };
        const addContact = (contact) => { setContacts(prev => [...prev, contact]); document.getElementById('add_contact_modal').close(); setNewContact(emptyContact); };
        const [newContact, setNewContact] = React.useState(emptyContact);

        return (
            <div className="bg-white rounded-2xl shadow-xl border border-gray-100">
                <div className="p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-semibold text-gray-800">Networking</h2>
                        <button className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors duration-200" 
                                onClick={() => document.getElementById('add_contact_modal').showModal()}>
                            <Icon name="plus" className="w-4 h-4"/> Add Contact
                        </button>
                    </div>
                    {contacts.length === 0 ? (
                        <div className="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                            <Icon name="users" className="w-16 h-16 mx-auto text-gray-300" />
                            <p className="mt-4 text-xl font-semibold text-gray-600">No contacts yet</p>
                            <p className="text-sm text-gray-500 mt-1">Start building your professional network</p>
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-gray-200">
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'20%'}}>Name</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'20%'}}>Company</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'20%'}}>Role</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'15%'}}>Contact Date</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm">Notes</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'5%'}}></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {contacts.map((c) => (
                                        <tr key={c.id} className="border-b border-gray-100 transition-colors duration-150"
                                            onMouseOver={e => e.currentTarget.style.backgroundColor = '#F9FAFB'}
                                            onMouseOut={e => e.currentTarget.style.backgroundColor = 'transparent'}>
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Name} onChange={e => updateContact(c.id, 'Name', e.target.value)} placeholder="Name" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Company} onChange={e => updateContact(c.id, 'Company', e.target.value)} placeholder="Company" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Role} onChange={e => updateContact(c.id, 'Role', e.target.value)} placeholder="Role" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="date" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.ContactDate} onChange={e => updateContact(c.id, 'ContactDate', e.target.value)} />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Notes} onChange={e => updateContact(c.id, 'Notes', e.target.value)} placeholder="Notes" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <button className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors duration-150" 
                                                        onClick={()=>deleteContact(c.id)}>
                                                    <Icon name="trash-2" className="w-4 h-4"/>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
                <Modal id="add_contact_modal" title="Add New Contact">
                    <div className="space-y-4">
                        <input type="text" placeholder="Name" className="input input-bordered w-full" 
                               value={newContact.Name} onChange={e => setNewContact({...newContact, Name: e.target.value})} />
                        <input type="text" placeholder="Company" className="input input-bordered w-full" 
                               value={newContact.Company} onChange={e => setNewContact({...newContact, Company: e.target.value})} />
                        <input type="text" placeholder="Role" className="input input-bordered w-full" 
                               value={newContact.Role} onChange={e => setNewContact({...newContact, Role: e.target.value})} />
                        <input type="date" className="input input-bordered w-full" 
                               value={newContact.ContactDate} onChange={e => setNewContact({...newContact, ContactDate: e.target.value})} />
                        <textarea className="textarea textarea-bordered w-full" placeholder="Notes" 
                                  value={newContact.Notes} onChange={e => setNewContact({...newContact, Notes: e.target.value})}></textarea>
                        <div className="modal-action">
                            <button type="button" className="btn" onClick={() => document.getElementById('add_contact_modal').close()}>Cancel</button>
                            <button type="button" className="btn btn-primary" onClick={() => addContact({...newContact, id: `contact-${Date.now()}`})}>Save</button>
                        </div>
                    </div>
                </Modal>
            </div>
        );
    }
    
    /********* Kanban Components *********/
    function KanbanCard({ job }) {
      const handleDragStart = (e) => {
        e.dataTransfer.setData("jobId", job.id);
        e.currentTarget.classList.add('opacity-50', 'scale-95');
      };
      
      const handleDragEnd = (e) => {
        e.currentTarget.classList.remove('opacity-50', 'scale-95');
      };

      return (
        <div 
          id={job.id}
          draggable="true" 
          onDragStart={handleDragStart}
          onDragEnd={handleDragEnd}
          className="bg-white p-3 rounded-lg shadow-sm border border-gray-200 hover:shadow-md hover:border-blue-400 transition-all duration-200 cursor-grab active:cursor-grabbing"
        >
          <div className="font-semibold text-gray-800 text-sm">{job.Company}</div>
          <p className="text-xs text-gray-600">{job.Title}</p>
          <div className={`text-xs mt-2 p-1 rounded-md inline-block ${getDeadlineClass(job.AppDeadline)}`}>
            {job.AppDeadline ? `Due: ${job.AppDeadline}` : 'No Deadline'}
          </div>
        </div>
      );
    }

    function KanbanColumn({ status, jobs, onDropJob }) {
      const [isDragOver, setIsDragOver] = React.useState(false);

      const handleDragOver = (e) => {
        e.preventDefault();
        setIsDragOver(true);
      };
      
      const handleDragLeave = () => {
        setIsDragOver(false);
      };

      const handleDrop = (e) => {
        e.preventDefault();
        const jobId = e.dataTransfer.getData("jobId");
        onDropJob(jobId, status);
        setIsDragOver(false);
      };

      return (
        <div 
          onDragOver={handleDragOver}
          onDrop={handleDrop}
          onDragLeave={handleDragLeave}
          className={`flex-shrink-0 w-72 bg-gray-50 rounded-xl p-3 transition-colors duration-300 ${isDragOver ? 'bg-blue-100' : ''}`}
        >
          <div className="flex justify-between items-center mb-4">
            <h3 className="font-semibold text-gray-700">{status}</h3>
            <span className="bg-gray-200 text-gray-600 text-xs font-bold px-2 py-1 rounded-full">{jobs.length}</span>
          </div>
          <div className="space-y-3 min-h-48">
            {jobs.map(job => <KanbanCard key={job.id} job={job} />)}
            {isDragOver && <div className="rounded-lg border-2 border-dashed border-blue-400 bg-blue-50 h-24" />}
          </div>
        </div>
      );
    }
    
    function KanbanBoard({ jobs, onJobStatusChange }) {
      const handleDropJob = (jobId, newStatus) => {
        const job = jobs.find(j => j.id === jobId);
        if (job && job.Status !== newStatus) {
            let newJobStatus = newStatus;
            if(newStatus === 'Backlog') {
                const isRejectedOrWithdrawn = ["Rejected", "Withdrawn", "Offer Accepted"].includes(job.Status);
                newJobStatus = isRejectedOrWithdrawn ? job.Status : "To Apply";
            }
            onJobStatusChange(jobId, newJobStatus);
        }
      };

      const boardJobs = jobs.filter(j => KANBAN_COLUMNS.includes(j.Status) || j.Status === 'Backlog');
      const backlogJobs = jobs.filter(j => !KANBAN_COLUMNS.includes(j.Status) || j.Status === 'Backlog');
      
      const jobsByStatus = KANBAN_COLUMNS.reduce((acc, status) => {
          acc[status] = [];
          return acc;
      }, {});

      jobs.forEach(job => {
          if (KANBAN_COLUMNS.includes(job.Status)) {
              jobsByStatus[job.Status].push(job);
          } else {
              if(!jobsByStatus['Backlog']) jobsByStatus['Backlog'] = [];
              jobsByStatus['Backlog'].push(job);
          }
      });

      return (
        <div className="bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
            <div className="flex overflow-x-auto space-x-4 pb-4">
                {KANBAN_COLUMNS.map(status => (
                    <KanbanColumn 
                        key={status}
                        status={status}
                        jobs={jobsByStatus[status] || []}
                        onDropJob={handleDropJob}
                    />
                ))}
            </div>
        </div>
      );
    }

    function App() {
      const { user, loading: authLoading, signOut } = useAuth();
      const { jobs, contacts, loading: dataLoading, updateJobs, updateContacts, loadUserData } = useFirebaseData(user);
      const [jobSearchTerm, setJobSearchTerm] = React.useState('');
      const [contactSearchTerm, setContactSearchTerm] = React.useState('');
      const [statusFilter, setStatusFilter] = React.useState('All');
      const [jobTypeFilter, setJobTypeFilter] = React.useState('All');
      const [sourceFilter, setSourceFilter] = React.useState('All');
      const [locationFilter, setLocationFilter] = React.useState('');
      const [showAdvancedFilters, setShowAdvancedFilters] = React.useState(false);
      const [selectedMetricFilters, setSelectedMetricFilters] = React.useState([]);
      const [newJob, setNewJob] = React.useState(emptyJob);
      const [showKanban, setShowKanban] = React.useState(false);

      const filteredJobs = React.useMemo(() => {
        let filtered = jobs;
        
        // Apply metric-based filters if any are selected
        if (selectedMetricFilters.length > 0) {
          filtered = filtered.filter(job => {
            return selectedMetricFilters.some(filter => {
              switch(filter) {
                case 'offers':
                  return ["Offer Received", "Offer Accepted"].includes(job.Status);
                case 'rejected':
                  return job.Status === "Rejected";
                case 'inProgress':
                  return ["Applied", "HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview"].includes(job.Status);
                case 'total':
                  return true; // All jobs
                default:
                  return false;
              }
            });
          });
        }
        
        return filtered
          .filter(job => statusFilter === 'All' || job.Status === statusFilter)
          .filter(job => jobTypeFilter === 'All' || job.JobType === jobTypeFilter)
          .filter(job => sourceFilter === 'All' || job.Source === sourceFilter)
          .filter(job => locationFilter === '' || job.Location.toLowerCase().includes(locationFilter.toLowerCase()))
          .filter(job => jobSearchTerm === '' || 
            job.Company.toLowerCase().includes(jobSearchTerm.toLowerCase()) || 
            job.Title.toLowerCase().includes(jobSearchTerm.toLowerCase()) ||
            job.NextStep.toLowerCase().includes(jobSearchTerm.toLowerCase())
          );
      }, [jobs, selectedMetricFilters, statusFilter, jobTypeFilter, sourceFilter, locationFilter, jobSearchTerm]);

      const filteredContacts = React.useMemo(() => {
        return contacts.filter(contact => 
          contactSearchTerm === '' || 
          contact.Name.toLowerCase().includes(contactSearchTerm.toLowerCase()) || 
          contact.Company.toLowerCase().includes(contactSearchTerm.toLowerCase()) ||
          contact.Role.toLowerCase().includes(contactSearchTerm.toLowerCase())
        );
      }, [contacts, contactSearchTerm]);

      const handleSaveNewJob = (job) => {
        updateJobs(prev => [job, ...prev]);
        document.getElementById('add_job_modal').close();
        setNewJob(emptyJob);
        showToast('Application added!');
      };

      const handleJobStatusChange = (jobId, newStatus) => {
        const newJobs = jobs.map(job => 
          job.id === jobId ? { ...job, Status: newStatus } : job
        );
        updateJobs(newJobs);
        showToast(`Moved to ${newStatus}`, 'info');
      };

      // Show loading screen while authenticating
      if (authLoading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-center">
              <div className="bg-blue-500 p-4 rounded-2xl w-16 h-16 mx-auto mb-4 animate-pulse">
                <Icon name="briefcase" className="w-8 h-8 text-white"/>
              </div>
              <div className="text-xl font-semibold text-gray-700">Loading CareerFlow...</div>
            </div>
          </div>
        );
      }

      // Show auth screen if not logged in
      if (!user) {
        return <AuthScreen />;
      }

      const handleMetricFilterToggle = (filterType) => {
        setSelectedMetricFilters(prev => {
          if (prev.includes(filterType)) {
            return prev.filter(f => f !== filterType);
          } else {
            return [...prev, filterType];
          }
        });
      };

      const handleDataAction = (action) => {
        if (action === 'export') { 
          const data = { jobs, contacts, exportDate: new Date().toISOString() };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `job-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          showToast('Data exported successfully!', 'success');
        } 
        else if (action === 'import') { 
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                try {
                  const data = JSON.parse(e.target.result);
                  if (data.jobs && Array.isArray(data.jobs)) {
                    updateJobs(data.jobs);
                    showToast(`Imported ${data.jobs.length} job applications!`, 'success');
                  }
                  if (data.contacts && Array.isArray(data.contacts)) {
                    updateContacts(data.contacts);
                    showToast(`Imported ${data.contacts.length} contacts!`, 'success');
                  }
                } catch (error) {
                  showToast('Error importing data. Please check the file format.', 'error');
                }
              };
              reader.readAsText(file);
            }
          };
          input.click();
        }
        else if (action === 'migrate_local') {
          const localJobs = localStorage.getItem('job-tracker-jobs-v4');
          const localContacts = localStorage.getItem('job-tracker-contacts-v4');
          
          if (localJobs || localContacts) {
            if (confirm('This will migrate your local data to Firebase. Your existing Firebase data will be replaced. Continue?')) {
              try {
                if (localJobs) {
                  const jobs = JSON.parse(localJobs);
                  updateJobs(jobs);
                  showToast(`Migrated ${jobs.length} job applications to Firebase!`, 'success');
                }
                if (localContacts) {
                  const contacts = JSON.parse(localContacts);
                  updateContacts(contacts);
                  showToast(`Migrated ${contacts.length} contacts to Firebase!`, 'success');
                }
                // Clear local storage after successful migration
                localStorage.removeItem('job-tracker-jobs-v4');
                localStorage.removeItem('job-tracker-contacts-v4');
                showToast('Local data migration completed!', 'success');
              } catch (error) {
                showToast('Error migrating local data.', 'error');
              }
            }
          } else {
            showToast('No local data found to migrate.', 'info');
          }
        }
        else if (action === 'restore_dummy') {
            if (confirm('Bu işlem mevcut tüm veriyi silip örnek verileri yükleyecek. Emin misiniz?')) {
                updateJobs(sampleJobs);
                updateContacts(sampleContacts);
                showToast('Örnek veriler başarıyla yüklendi!', 'success');
            }
        }
        else if (action === 'reset') {
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
                updateJobs([]);
                updateContacts([]);
                showToast('All data has been cleared.', 'info');
            }
        }
      };

      return (
        <div className="space-y-8 bg-gray-50 min-h-screen">
            <div className="bg-white shadow-lg border-b border-gray-200 sticky top-0 z-10">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex justify-between items-center py-4">
                  <div className="flex items-center gap-3">
                    <div className="bg-blue-500 p-2 rounded-lg">
                      <Icon name="briefcase" className="w-6 h-6 text-white"/>
                    </div>
                    <h1 className="text-2xl font-bold text-gray-900">CareerFlow</h1>
                  </div>
                  <div className="flex items-center gap-3">
                    {dataLoading && (
                      <div className="flex items-center gap-2 text-sm text-gray-600">
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
                        Syncing...
                      </div>
                    )}
                    <div className="dropdown dropdown-end">
                      <div tabIndex={0} role="button" className="btn btn-ghost btn-circle hover:bg-gray-100">
                        <Icon name="settings" className="w-5 h-5"/>
                      </div>
                      <ul tabIndex={0} className="menu menu-sm dropdown-content mt-3 z-[10] p-2 shadow-lg bg-white rounded-xl border border-gray-200 w-56">
                        <li><a onClick={() => handleDataAction('export')} className="text-blue-600 hover:bg-blue-50"><Icon name="download" className="w-4 h-4"/> Export Data</a></li>
                        <li><a onClick={() => handleDataAction('import')} className="text-green-600 hover:bg-green-50"><Icon name="upload" className="w-4 h-4"/> Import Data</a></li>
                        <li><hr className="my-1"/></li>
                        <li><a onClick={() => handleDataAction('migrate_local')} className="text-orange-600 hover:bg-orange-50"><Icon name="database" className="w-4 h-4"/> Migrate Local Data</a></li>
                        <li><a onClick={() => handleDataAction('restore_dummy')} className="text-purple-600 hover:bg-purple-50"><Icon name="refresh-cw" className="w-4 h-4"/> Restore Demo Data</a></li>
                        <li><hr className="my-1"/></li>
                        <li><a onClick={() => handleDataAction('reset')} className="text-red-600 hover:bg-red-50"><Icon name="trash" className="w-4 h-4"/> Reset All Data</a></li>
                      </ul>
                    </div>
                    <UserProfile user={user} onSignOut={signOut} />
                  </div>
                </div>
              </div>
            </div>

            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
              <Analytics jobs={jobs} selectedMetricFilters={selectedMetricFilters} onMetricFilterToggle={handleMetricFilterToggle} />
              
              <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                <div className="flex justify-between items-center">
                    <h2 className="text-2xl font-bold text-gray-900">Kanban View</h2>
                    <button 
                        className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-transform duration-300"
                        onClick={() => setShowKanban(!showKanban)}
                    >
                        <Icon name={showKanban ? 'chevrons-up' : 'chevrons-down'} className="w-5 h-5"/>
                        {showKanban ? 'Close Board' : 'Open Board'}
                    </button>
                </div>
                {showKanban && (
                    <div className="mt-6">
                        <KanbanBoard jobs={jobs} onJobStatusChange={handleJobStatusChange} />
                    </div>
                )}
              </div>

              <div className="space-y-6">
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                  <div className="flex justify-between items-center mb-4">
                      <h2 className="text-2xl font-bold text-gray-900">Job Applications</h2>
                      <button className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors duration-200" 
                              onClick={() => document.getElementById('add_job_modal').showModal()}>
                          <Icon name="plus" className="w-5 h-5"/> New Application
                      </button>
                  </div>
                  
                  <div className="space-y-4">
                    <div className="flex flex-wrap items-center gap-4">
                      <input type="text" placeholder="Search by company, title, or notes..." 
                             className="flex-1 min-w-64 px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                             onChange={e => setJobSearchTerm(e.target.value)} />
                      <button 
                        className="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg border border-blue-200 text-sm flex items-center gap-2 transition-colors duration-200"
                        onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
                      >
                        <Icon name="filter" className="w-4 h-4"/>
                        {showAdvancedFilters ? 'Hide Filters' : 'Advanced Filters'}
                      </button>
                    </div>
                    
                    {showAdvancedFilters && (
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">Status</label>
                          <select className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                  value={statusFilter} onChange={e => setStatusFilter(e.target.value)}>
                              <option value="All">All Statuses</option>
                              {statusList.map(s => <option key={s} value={s}>{s}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">Job Type</label>
                          <select className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                  value={jobTypeFilter} onChange={e => setJobTypeFilter(e.target.value)}>
                              <option value="All">All Types</option>
                              {jobTypeList.map(t => <option key={t} value={t}>{t}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">Source</label>
                          <select className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                  value={sourceFilter} onChange={e => setSourceFilter(e.target.value)}>
                              <option value="All">All Sources</option>
                              {sourceList.map(s => <option key={s} value={s}>{s}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="block text-xs font-medium text-gray-700 mb-1">Location</label>
                          <input type="text" placeholder="Filter by location..." 
                                 className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                 value={locationFilter} onChange={e => setLocationFilter(e.target.value)} />
                        </div>
                      </div>
                    )}
                    
                    {(selectedMetricFilters.length > 0 || statusFilter !== 'All' || jobTypeFilter !== 'All' || sourceFilter !== 'All' || locationFilter !== '' || jobSearchTerm !== '') && (
                      <div className="flex items-center gap-2 flex-wrap">
                        <span className="text-sm text-gray-600">Active filters:</span>
                        {selectedMetricFilters.map(filter => {
                          const labels = { total: 'All Applications', inProgress: 'In Progress', offers: 'Offers', rejected: 'Rejected' };
                          const colors = { total: 'bg-blue-100 text-blue-800', inProgress: 'bg-amber-100 text-amber-800', offers: 'bg-emerald-100 text-emerald-800', rejected: 'bg-red-100 text-red-800' };
                          return <span key={filter} className={`px-2 py-1 text-xs rounded-full ${colors[filter]}`}>{labels[filter]}</span>;
                        })}
                        {statusFilter !== 'All' && <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Status: {statusFilter}</span>}
                        {jobTypeFilter !== 'All' && <span className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Type: {jobTypeFilter}</span>}
                        {sourceFilter !== 'All' && <span className="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">Source: {sourceFilter}</span>}
                        {locationFilter !== '' && <span className="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Location: {locationFilter}</span>}
                        {jobSearchTerm !== '' && <span className="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">Search: "{jobSearchTerm}"</span>}
                        <button 
                          className="text-xs text-red-600 hover:text-red-800 ml-2"
                          onClick={() => {
                            setSelectedMetricFilters([]);
                            setStatusFilter('All');
                            setJobTypeFilter('All');
                            setSourceFilter('All');
                            setLocationFilter('');
                            setJobSearchTerm('');
                          }}
                        >
                          Clear all
                        </button>
                      </div>
                    )}
                  </div>
                </div>
                
                <div className="bg-white rounded-xl shadow-sm border border-gray-100">
                  <div className="p-4 border-b border-gray-100">
                    <div className="flex items-center justify-between">
                      <div className="text-sm text-gray-600">
                        Showing {filteredJobs.length} of {jobs.length} applications
                      </div>
                      {filteredJobs.length !== jobs.length && (
                        <div className="text-xs text-blue-600">
                          {jobs.length - filteredJobs.length} applications filtered out
                        </div>
                      )}
                    </div>
                  </div>
                  <TrackerTable jobs={filteredJobs} setJobs={updateJobs} />
                </div>
                
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                  <div className="flex justify-between items-center mb-4">
                      <h2 className="text-2xl font-bold text-gray-900">Networking</h2>
                      <input type="text" placeholder="Search contacts by name, company, or role..." 
                             className="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-80" 
                             onChange={e => setContactSearchTerm(e.target.value)} />
                  </div>
                  {filteredContacts.length !== contacts.length && (
                    <div className="mb-4 text-sm text-gray-600">
                      Showing {filteredContacts.length} of {contacts.length} contacts
                    </div>
                  )}
                                     <ContactsTable contacts={filteredContacts} setContacts={updateContacts} />
                </div>
              </div>
            </div>
            
            <Modal id="add_job_modal" title="Add New Job Application">
              <JobForm jobData={newJob} onSave={handleSaveNewJob} onCancel={() => document.getElementById('add_job_modal').close()} />
            </Modal>
        </div>
      );
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
</html>