<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>CareerFlow - Professional Application Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAIQSURBVEhL7ZRLSwNBEIb/RCyIWEREEAQfElAREfFNEf+CAmJBiIgIIgiCIIgISyAiiSAgCOJ/AsElHyAie6e3s7OOKzV5EFy4qeqq6Z6e3tkdMMZ/zF+bOPk+kE3G8ryJ2F+9s5wfJ9a0lAA4wA1m6jAD45l6gKkPAzYAG8Mg1uKAXwA9sUuO5YqD2Fm2VCDA1V4C1sUan4gWw4FG2ZgA7Iq7f/41Yl4k2gVzPoclhO/kO4l2AzsW4p2pY3jS2w2PcPqA7dI1h4aLwGnwhk1nCg8I+pLiXGfAB43V1BfAk41XlBfD5rmoLsDKerDQmYlAMMRd2cAi3wBf/gXo2/kNmGisfsNwz4E2eDYOtl2fXQ1W7bI0j4Q0YyA2zCLwA8+lsuGSx1t1wZ/gTqfIN2Nl2eXwA+BGn8jYnlYB5xSg/T+E2b/43ge3bAsws7oBCpUn885wc13aY5k2g8T2YIny2kQ2QG0h1hA9Uxx8gK0n6L1u9NBzcjxijrgrwY8Y5wVe1n4C52g1gNOzQkTsSHq5z4jPMR4NnTPpIGu+17L44wLgAbY5vAJ5E3851G7j8sgaMPg2gSg2gSg2gSg3gC4p7wAjw+q5qC/Ak41XlBfD5rmoLsDKerDQmYlAMMRd2cAi3wBf/gXo2/kNmGisfsNwzYJPwXg3sZDcGSx1t1wZ/gTqfIN2Nl2eXwA+BGn8jYn1YBy4+UJT/sAxz+MKL/xrFvG3hA/j9AdB7Xl2uVwJb/KEbEyHagxQXs2OC1QE0yDEr9wqun2eZBtC430GvNOLe8l8gvgt9pA9Uxx8gK0n6L1u9NBzcjxijrgrwY8Y5wVe1n4C52g1gNOzQkTsSHq5z4jPMR4NnTPpIGu+17L44wLgAbY5vAJ5E3851G7j8sgaMPg2gSg2gSg2gSg3gC4p7wAjw+q5qC/Ak41XlBfD5rmoLsDKerDQmYlAMMRd2cAi3wBf/gXo2/kNmGisfsNwzYJPwXg3sZDcGSx1t1wZ/gTqfIN2Nl2eXwA+BGn8jYn1YBy4+UJT/sAxz+MKL/xolx2uM3wJj/PPgfzRI0VnBAi10AAAAASUVORK5CYII=">
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.11.1/dist/full.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBmc11Cf_-op_e2HikOKhx2zhlUKN51aew",
      authDomain: "careerflow-app.firebaseapp.com",
      projectId: "careerflow-app",
      storageBucket: "careerflow-app.firebasestorage.app",
      messagingSenderId: "616353508218",
      appId: "1:616353508218:web:f9ca9d3d028fd6b7b484c3",
      measurementId: "G-V8RW33STR9"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    // Make Firebase services available globally
    window.firebase = {
      auth: auth,
      db: db,
      provider: provider,
      signInWithPopup: auth.signInWithPopup.bind(auth),
      signOut: auth.signOut.bind(auth),
      onAuthStateChanged: auth.onAuthStateChanged.bind(auth),
      collection: db.collection.bind(db),
      doc: db.doc.bind(db),
      setDoc: (docRef, data) => docRef.set(data),
      getDoc: (docRef) => docRef.get(),
      getDocs: (query) => query.get(),
      deleteDoc: (docRef) => docRef.delete(),
      onSnapshot: (query, callback) => query.onSnapshot(callback),
      serverTimestamp: firebase.firestore.FieldValue.serverTimestamp
    };
  </script>
</head>
<body class="bg-base-200 min-h-screen font-sans">
  
  <main id="root" class="container mx-auto p-4 md:p-6"></main>
  <div id="toast-container" class="toast toast-bottom toast-end z-50"></div>

  <script type="text/babel">
    /********* Injected data & Config *********/
    const statusList = ["Wishlist", "Applied", "HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview", "Offer Received", "Offer Accepted", "Rejected", "Withdrawn"];
    const jobTypeList = ["Internship", "Full-Time", "Part-Time", "Thesis Project"];
    const sourceList  = ["Polimi CareerService", "LinkedIn", "Company Website", "Referral", "Networking Event", "Other"];
    const DOUGHNUT_COLORS = { Offers: '#22C55E', Rejected: '#EF4444', 'In-Progress': '#F59E0B', Other: '#8B5CF6' };
    const KANBAN_COLUMNS = ["Backlog", "Applied", "HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview", "Offer Received"];

    const getTodayPlusDays = (days) => new Date(new Date().setDate(new Date().getDate() + days)).toISOString().split('T')[0];
    const sampleJobs  = [];
    const sampleContacts = [];

    /********* Firebase Services *********/
    const FirebaseService = {
      async saveJobs(userId, jobs) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('jobs');
          const sanitizeJobs = (jobs) => {
            if (!Array.isArray(jobs)) {
              console.error('Expected jobs to be an array, but got:', jobs);
              return [];
            }
            return jobs.map(job => {
              const sanitizedJob = {};
              for (const key in job) {
                if (typeof job[key] !== 'function') {
                  sanitizedJob[key] = job[key];
                }
              }
              return sanitizedJob;
            });
          };
          const sanitizedJobs = sanitizeJobs(jobs);
          await docRef.set({
            jobs: sanitizedJobs,
            lastUpdated: window.firebase.serverTimestamp()
          });
        } catch (error) {
          console.error('Error saving jobs:', error);
          throw error;
        }
      },

      async loadJobs(userId) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('jobs');
          const docSnap = await docRef.get();
          if (docSnap.exists) {
            return docSnap.data().jobs || [];
          }
          return [];
        } catch (error) {
          console.error('Error loading jobs:', error);
          return [];
        }
      },

      async saveContacts(userId, contacts) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('contacts');
          await docRef.set({
            contacts: contacts,
            lastUpdated: window.firebase.serverTimestamp()
          });
        } catch (error) {
          console.error('Error saving contacts:', error);
          throw error;
        }
      },

      async loadContacts(userId) {
        try {
          const docRef = window.firebase.db.collection('users').doc(userId).collection('data').doc('contacts');
          const docSnap = await docRef.get();
          if (docSnap.exists) {
            return docSnap.data().contacts || [];
          }
          return [];
        } catch (error) {
          console.error('Error loading contacts:', error);
          return [];
        }
      }
    };

    /********* Helpers & Custom Hooks *********/
    const emptyJob = { Status:"Wishlist", Company:"", Title:"", JobType:"Internship", Location:"", Source:"Polimi CareerService", DateApplied:"", NextStep:"" };
    const emptyContact = { Name:"", Company:"", Role:"", Location:"", ContactDate:"", Notes:"" };

    function useAuth() {
      const [user, setUser] = React.useState(null);
      const [loading, setLoading] = React.useState(true);

      React.useEffect(() => {
        const unsubscribe = window.firebase.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      const signIn = async () => {
        try {
          await window.firebase.signInWithPopup(window.firebase.provider);
          showToast('Successfully signed in!', 'success');
        } catch (error) {
          console.error('Sign in error:', error);
          showToast('Failed to sign in. Please try again.', 'error');
        }
      };

      const signOut = async () => {
        try {
          await window.firebase.signOut();
          showToast('Successfully signed out!', 'info');
        } catch (error) {
          console.error('Sign out error:', error);
          showToast('Failed to sign out.', 'error');
        }
      };

      return { user, loading, signIn, signOut };
    }

    function useFirebaseData(user) {
      const [jobs, setJobs] = React.useState([]);
      const [contacts, setContacts] = React.useState([]);
      const [loading, setLoading] = React.useState(true);

      // Load data when user changes
      React.useEffect(() => {
        if (user) {
          loadUserData();
        } else {
          setJobs([]);
          setContacts([]);
          setLoading(false);
        }
      }, [user]);

      const loadUserData = async () => {
        if (!user) return;
        
        setLoading(true);
        try {
          const [jobsData, contactsData] = await Promise.all([
            FirebaseService.loadJobs(user.uid),
            FirebaseService.loadContacts(user.uid)
          ]);
          setJobs(jobsData);
          setContacts(contactsData);
        } catch (error) {
          console.error('Error loading user data:', error);
          showToast('Failed to load your data.', 'error');
        }
        setLoading(false);
      };

      const updateJobs = async (newJobs) => {
        if (!user) return;
        
        // Handle both direct array and function updates
        if (typeof newJobs === 'function') {
          setJobs(prevJobs => {
            const updatedJobs = newJobs(prevJobs);
            // Save to Firebase in the background
            FirebaseService.saveJobs(user.uid, updatedJobs).catch(error => {
              console.error('Error saving jobs:', error);
              showToast('Failed to save jobs. Changes may be lost.', 'error');
            });
            return updatedJobs;
          });
        } else {
          setJobs(newJobs);
          try {
            await FirebaseService.saveJobs(user.uid, newJobs);
          } catch (error) {
            console.error('Error saving jobs:', error);
            showToast('Failed to save jobs. Changes may be lost.', 'error');
          }
        }
      };

      const updateContacts = async (newContacts) => {
        if (!user) return;
        
        setContacts(newContacts);
        try {
          await FirebaseService.saveContacts(user.uid, newContacts);
        } catch (error) {
          console.error('Error saving contacts:', error);
          showToast('Failed to save contacts. Changes may be lost.', 'error');
        }
      };

      return { jobs, contacts, loading, updateJobs, updateContacts, loadUserData };
    }

    function useLocalStorage(key, initialValue) {
      const [storedValue, setStoredValue] = React.useState(() => {
        try { const item = window.localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; } 
        catch (error) { return initialValue; }
      });
      const setValue = (value) => {
        try {
          const valueToStore = value instanceof Function ? value(storedValue) : value;
          setStoredValue(valueToStore);
          window.localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (error) { console.error(error); }
      };
      return [storedValue, setValue];
    }
    
    const showToast = (message, type = 'success') => {
        const toastContainer = document.getElementById('toast-container');
        const toastId = `toast-${Date.now()}`;
        const alertClass = { success: 'alert-success', error: 'alert-error', info: 'alert-info' }[type];
        const toastElement = document.createElement('div');
        toastElement.id = toastId;
        toastElement.className = `alert ${alertClass} shadow-lg`;
        toastElement.innerHTML = `<span>${message}</span>`;
        toastContainer.appendChild(toastElement);
        setTimeout(() => { toastElement.remove() }, 3000);
    };

    const getDeadlineClass = (deadline) => {
      if (!deadline) return '';
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const deadlineDate = new Date(deadline);
      const diffDays = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
      if (diffDays <= 0) return 'text-error font-bold';
      if (diffDays <= 3) return 'text-warning font-bold';
      if (diffDays <= 7) return 'text-success font-bold';
      return '';
    };

    const getStatusColorClass = (status) => {
        const colors = {
            "Applied": "bg-blue-50 border-l-4 border-blue-400",
            "HR Screening": "bg-amber-50 border-l-4 border-amber-400",
            "Technical Interview": "bg-purple-50 border-l-4 border-purple-400",
            "Case Study / Assessment": "bg-indigo-50 border-l-4 border-indigo-400",
            "Final Interview": "bg-pink-50 border-l-4 border-pink-400",
            "Offer Received": "bg-green-50 border-l-4 border-green-500",
            "Offer Accepted": "bg-emerald-50 border-l-4 border-emerald-600",
            "Rejected": "bg-red-50 border-l-4 border-red-400",
            "Withdrawn": "bg-gray-50 border-l-4 border-gray-400"
        };
        return colors[status] || "bg-white";
    };

    /********* Reusable Components *********/
    function Icon({ name, className = "w-5 h-5" }) {
        return <span className="inline-block" dangerouslySetInnerHTML={{ __html: feather.icons[name].toSvg({ class: className }) }} />;
    }

    function Tooltip({ children, text }) {
        if (!text) return children;
        return (
            <div className="tooltip w-full" data-tip={text}>
                {children}
            </div>
        );
    }

    function AutocompleteInput({ value, onChange, placeholder, suggestions, className, hasError }) {
        const [showSuggestions, setShowSuggestions] = React.useState(false);
        const [filteredSuggestions, setFilteredSuggestions] = React.useState([]);
        const inputRef = React.useRef(null);
        const suggestionRef = React.useRef(null);

        React.useEffect(() => {
            if (value && suggestions.length > 0) {
                const filtered = suggestions
                    .filter(suggestion => 
                        suggestion.toLowerCase().includes(value.toLowerCase()) && 
                        suggestion.toLowerCase() !== value.toLowerCase()
                    )
                    .slice(0, 5); // Limit to 5 suggestions
                setFilteredSuggestions(filtered);
                setShowSuggestions(filtered.length > 0);
            } else {
                setShowSuggestions(false);
            }
        }, [value, suggestions]);

        React.useEffect(() => {
            const handleClickOutside = (event) => {
                if (suggestionRef.current && !suggestionRef.current.contains(event.target) && 
                    inputRef.current && !inputRef.current.contains(event.target)) {
                    setShowSuggestions(false);
                }
            };

            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
        }, []);

        const handleInputChange = (e) => {
            onChange(e.target.value);
        };

        const handleSuggestionClick = (suggestion) => {
            onChange(suggestion);
            setShowSuggestions(false);
            inputRef.current?.focus();
        };

        const handleKeyDown = (e) => {
            if (e.key === 'Escape') {
                setShowSuggestions(false);
            }
        };

        return (
            <div className="relative w-full">
                <input
                    ref={inputRef}
                    type="text"
                    value={value}
                    onChange={handleInputChange}
                    onKeyDown={handleKeyDown}
                    placeholder={placeholder}
                    className={className}
                    autoComplete="off"
                />
                {showSuggestions && (
                    <div 
                        ref={suggestionRef}
                        className="absolute top-full left-0 right-0 z-50 bg-white border border-gray-200 rounded-lg shadow-lg max-h-48 overflow-y-auto"
                    >
                        {filteredSuggestions.map((suggestion, index) => (
                            <div
                                key={index}
                                onClick={() => handleSuggestionClick(suggestion)}
                                className="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 text-sm"
                            >
                                <div className="flex items-center gap-2">
                                    <Icon name="clock" className="w-3 h-3 text-gray-400" />
                                    <span>{suggestion}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    }

    function Modal({ id, title, children }) {
        return (
            <dialog id={id} className="modal">
                <div className="modal-box w-11/12 max-w-2xl"><form method="dialog"><button className="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form><h3 className="font-bold text-lg mb-4">{title}</h3>{children}</div>
                <form method="dialog" className="modal-backdrop"><button>close</button></form>
            </dialog>
        );
    }
    
    function ChartComponent({ chartId, type, data, options }) {
      const chartRef = React.useRef(null);
      React.useEffect(() => {
        const ctx = document.getElementById(chartId).getContext('2d');
        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(ctx, { type, data, options });
        return () => chartRef.current?.destroy();
      }, [data]);
      return <canvas id={chartId} style={{maxHeight: '220px'}}></canvas>;
    }

    /********* Auth Components *********/
    function AuthScreen() {
      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <div className="bg-blue-500 p-4 rounded-2xl w-16 h-16 mx-auto mb-4">
                <Icon name="briefcase" className="w-8 h-8 text-white"/>
              </div>
              <h1 className="text-3xl font-bold text-gray-900 mb-2">CareerFlow</h1>
              <p className="text-gray-600">Professional Application Tracker</p>
            </div>
            
            <div className="space-y-6">
              <div className="text-center">
                <h2 className="text-xl font-semibold text-gray-800 mb-2">Welcome Back</h2>
                <p className="text-gray-600 text-sm">Sign in to access your job application data</p>
              </div>
              
              <AuthButton />
              
              <div className="text-center text-xs text-gray-500">
                <p>Your data is securely stored in Firebase</p>
                <p>and synced across all your devices</p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function AuthButton() {
      const { signIn } = useAuth();
      
      return (
        <button 
          onClick={signIn}
          className="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 flex items-center justify-center gap-3 hover:bg-gray-50 transition-colors duration-200 shadow-sm"
        >
          <svg className="w-5 h-5" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Continue with Google
        </button>
      );
    }

    function UserProfile({ user, onSignOut }) {
      return (
        <div className="dropdown dropdown-end">
          <div tabIndex={0} role="button" className="btn btn-ghost btn-circle avatar">
            <div className="w-8 rounded-full">
              <img src={user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=3b82f6&color=fff`} alt="Profile" />
            </div>
          </div>
          <ul tabIndex={0} className="menu menu-sm dropdown-content mt-3 z-[10] p-2 shadow-lg bg-white rounded-xl border border-gray-200 w-64">
            <li className="p-2 border-b border-gray-100">
              <div className="flex flex-col">
                <span className="font-medium text-gray-900">{user.displayName || 'User'}</span>
                <span className="text-xs text-gray-500">{user.email}</span>
              </div>
            </li>
            <li><a onClick={onSignOut} className="text-red-600 hover:bg-red-50"><Icon name="log-out" className="w-4 h-4"/> Sign Out</a></li>
          </ul>
        </div>
      );
    }
    
    /********* Main Components *********/
    function Analytics({ jobs, selectedMetricFilters, onMetricFilterToggle }) {
      const metrics = React.useMemo(() => {
        return jobs.reduce((acc, job) => {
          acc.total++;
          if (["Offer Received", "Offer Accepted"].includes(job.Status)) acc.offers++;
          else if (job.Status === "Rejected") acc.rejected++;
          else if (["Applied", "HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview"].includes(job.Status)) acc.inProgress++;
          return acc;
        }, { total: 0, offers: 0, rejected: 0, inProgress: 0 });
      }, [jobs]);

      const timelineData = React.useMemo(() => {
        // Group applications by month for timeline
        const monthlyData = {};
        const today = new Date();
        
        // Initialize last 3 months
        for (let i = 2; i >= 0; i--) {
          const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
          const monthKey = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          monthlyData[monthKey] = { applied: 0, offers: 0, rejected: 0, interviews: 0, responses: 0 };
        }
        
        jobs.forEach(job => {
          if (job.DateApplied) {
            const appDate = new Date(job.DateApplied);
            const monthKey = appDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            
            if (monthlyData[monthKey]) {
              monthlyData[monthKey].applied++;
              if (["Offer Received", "Offer Accepted"].includes(job.Status)) {
                monthlyData[monthKey].offers++;
                monthlyData[monthKey].responses++;
              } else if (job.Status === "Rejected") {
                monthlyData[monthKey].rejected++;
                monthlyData[monthKey].responses++;
              } else if (["HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview"].includes(job.Status)) {
                monthlyData[monthKey].interviews++;
                monthlyData[monthKey].responses++;
              }
            }
          }
        });

        // Calculate rates
        const processedData = Object.entries(monthlyData).map(([month, data]) => ({
          month,
          ...data,
          responseRate: data.applied > 0 ? Math.round((data.responses / data.applied) * 100) : 0,
          successRate: data.applied > 0 ? Math.round((data.offers / data.applied) * 100) : 0,
          interviewRate: data.applied > 0 ? Math.round((data.interviews / data.applied) * 100) : 0
        }));

        const labels = processedData.map(d => d.month);
        const appliedData = processedData.map(d => d.applied);
        const offersData = processedData.map(d => d.offers);
        const rejectedData = processedData.map(d => d.rejected);
        const responseRates = processedData.map(d => d.responseRate);
        const successRates = processedData.map(d => d.successRate);

        return {
          labels,
          datasets: [
            {
              label: 'Applications',
              data: appliedData,
              backgroundColor: 'rgba(59, 130, 246, 0.5)',
              borderColor: 'rgb(59, 130, 246)',
              borderWidth: 2,
              type: 'bar',
              yAxisID: 'y',
            },
            {
              label: 'Offers',
              data: offersData,
              backgroundColor: 'rgba(34, 197, 94, 0.5)',
              borderColor: 'rgb(34, 197, 94)',
              borderWidth: 2,
              type: 'bar',
              yAxisID: 'y',
            },
            {
              label: 'Rejected',
              data: rejectedData,
              backgroundColor: 'rgba(239, 68, 68, 0.5)',
              borderColor: 'rgb(239, 68, 68)',
              borderWidth: 2,
              type: 'bar',
              yAxisID: 'y',
            },
            {
              label: 'Response Rate (%)',
              data: responseRates,
              backgroundColor: 'rgba(147, 51, 234, 0.1)',
              borderColor: 'rgb(147, 51, 234)',
              borderWidth: 3,
              type: 'line',
              fill: false,
              tension: 0.4,
              yAxisID: 'y1',
              pointBackgroundColor: 'rgb(147, 51, 234)',
              pointBorderColor: 'rgb(147, 51, 234)',
              pointRadius: 6,
            },
            {
              label: 'Success Rate (%)',
              data: successRates,
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              borderColor: 'rgb(245, 158, 11)',
              borderWidth: 3,
              type: 'line',
              fill: false,
              tension: 0.4,
              yAxisID: 'y1',
              pointBackgroundColor: 'rgb(245, 158, 11)',
              pointBorderColor: 'rgb(245, 158, 11)',
              pointRadius: 6,
            }
          ],
          stats: processedData
        };
      }, [jobs]);

      const doughnutData = {
        labels: ['Offers', 'Rejected', 'In-Progress', 'Other'],
        datasets: [{
          data: [metrics.offers, metrics.rejected, metrics.inProgress, metrics.total - metrics.offers - metrics.rejected - metrics.inProgress],
          backgroundColor: ['#10B981', '#EF4444', '#F59E0B', '#8B5CF6'],
          borderWidth: 0,
          borderRadius: 8,
          spacing: 2,
        }]
      };
      
      const barData = {
        labels: statusList,
        datasets: [{
          label: 'Applications',
          data: statusList.map(s => jobs.filter(j => j.Status === s).length),
          backgroundColor: statusList.map((_, i) => {
            const colors = ['#8B5CF6', '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1', '#14B8A6'];
            return colors[i % colors.length];
          }),
          borderRadius: 4,
          borderSkipped: false,
        }]
      };

      return (
        <div className="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl border border-gray-100">
          <div className="p-6 space-y-6">
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className={`bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 ${
                    selectedMetricFilters.includes('total') ? 'border-blue-400 ring-2 ring-blue-200 shadow-lg' : 'border-blue-200/50 hover:shadow-md'
                  }`} onClick={() => onMetricFilterToggle('total')}>
                    <div className="text-xs font-medium text-blue-600 uppercase tracking-wide">Total Apps</div>
                    <div className="text-2xl font-bold text-blue-700 mt-1 flex items-center justify-center gap-2">
                      {metrics.total} <Icon name="layers" className="w-5 h-5"/>
                    </div>
                    {selectedMetricFilters.includes('total') && (
                      <div className="mt-2"><span className="inline-block w-2 h-2 bg-blue-500 rounded-full"></span></div>
                    )}
                  </div>
                  <div className={`bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 ${
                    selectedMetricFilters.includes('inProgress') ? 'border-amber-400 ring-2 ring-amber-200 shadow-lg' : 'border-amber-200/50 hover:shadow-md'
                  }`} onClick={() => onMetricFilterToggle('inProgress')}>
                    <div className="text-xs font-medium text-amber-600 uppercase tracking-wide">In Progress</div>
                    <div className="text-2xl font-bold text-amber-700 mt-1 flex items-center justify-center gap-2">
                      {metrics.inProgress} <Icon name="clock" className="w-5 h-5"/>
                    </div>
                    {selectedMetricFilters.includes('inProgress') && (
                      <div className="mt-2"><span className="inline-block w-2 h-2 bg-amber-500 rounded-full"></span></div>
                    )}
                  </div>
                  <div className={`bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 ${
                    selectedMetricFilters.includes('offers') ? 'border-emerald-400 ring-2 ring-emerald-200 shadow-lg' : 'border-emerald-200/50 hover:shadow-md'
                  }`} onClick={() => onMetricFilterToggle('offers')}>
                    <div className="text-xs font-medium text-emerald-600 uppercase tracking-wide">Offers</div>
                    <div className="text-2xl font-bold text-emerald-700 mt-1 flex items-center justify-center gap-2">
                      {metrics.offers} <Icon name="thumbs-up" className="w-5 h-5"/>
                    </div>
                    {selectedMetricFilters.includes('offers') && (
                      <div className="mt-2"><span className="inline-block w-2 h-2 bg-emerald-500 rounded-full"></span></div>
                    )}
                  </div>
                  <div className={`bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-4 text-center border transition-all duration-200 cursor-pointer transform hover:scale-105 ${
                    selectedMetricFilters.includes('rejected') ? 'border-red-400 ring-2 ring-red-200 shadow-lg' : 'border-red-200/50 hover:shadow-md'
                  }`} onClick={() => onMetricFilterToggle('rejected')}>
                    <div className="text-xs font-medium text-red-600 uppercase tracking-wide">Rejected</div>
                    <div className="text-2xl font-bold text-red-700 mt-1 flex items-center justify-center gap-2">
                      {metrics.rejected} <Icon name="x-circle" className="w-5 h-5"/>
                    </div>
                    {selectedMetricFilters.includes('rejected') && (
                      <div className="mt-2"><span className="inline-block w-2 h-2 bg-red-500 rounded-full"></span></div>
                    )}
                  </div>
              </div>

              {jobs.length > 0 ? (
                <div className="space-y-8">
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                      <h3 className="font-semibold text-lg text-gray-800 mb-4">Application Timeline & Success Metrics</h3>
                      <div style={{height: '300px'}}>
                        <ChartComponent chartId="chart1" type="bar" data={timelineData} options={{
                          maintainAspectRatio: false,
                          interaction: { mode: 'index', intersect: false },
                          plugins: {
                            legend: { 
                              display: true, 
                              position: 'top',
                              labels: { 
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 }
                              }
                            },
                            tooltip: {
                              backgroundColor: 'rgba(0,0,0,0.8)',
                              titleColor: 'white',
                              bodyColor: 'white',
                              borderColor: 'rgba(0,0,0,0.1)',
                              borderWidth: 1,
                              filter: function(tooltipItem) {
                                return tooltipItem.datasetIndex <= 2; // Only show bars in tooltip
                              }
                            }
                          },
                          scales: {
                            x: {
                              grid: { display: false },
                              ticks: { color: '#6B7280', font: { size: 11 } },
                              border: { display: false }
                            },
                            y: {
                              type: 'linear',
                              display: true,
                              position: 'left',
                              beginAtZero: true,
                              ticks: { 
                                stepSize: 1, 
                                color: '#6B7280', 
                                font: { size: 11 } 
                              },
                              grid: { color: '#F3F4F6', lineWidth: 1 },
                              border: { display: false },
                              title: {
                                display: true,
                                text: 'Applications Count',
                                color: '#374151',
                                font: { size: 12, weight: 'bold' }
                              }
                            },
                            y1: {
                              type: 'linear',
                              display: true,
                              position: 'right',
                              beginAtZero: true,
                              max: 100,
                              ticks: { 
                                stepSize: 20,
                                color: '#6B7280', 
                                font: { size: 11 },
                                callback: function(value) {
                                  return value + '%';
                                }
                              },
                              grid: { drawOnChartArea: false },
                              border: { display: false },
                              title: {
                                display: true,
                                text: 'Success Rate (%)',
                                color: '#374151',
                                font: { size: 12, weight: 'bold' }
                              }
                            }
                          },
                          animation: { duration: 800, easing: 'easeInOutQuart' }
                        }} />
                      </div>
                      
                      {/* Timeline Stats */}
                      <div className="mt-6 grid grid-cols-3 gap-4">
                        {timelineData.stats && timelineData.stats.map((monthData, index) => (
                          <div key={monthData.month} className="bg-gray-50 rounded-lg p-3">
                            <div className="text-sm font-semibold text-gray-700 mb-2">{monthData.month}</div>
                            <div className="space-y-1 text-xs text-gray-600">
                              <div className="flex justify-between">
                                <span>Applied:</span>
                                <span className="font-medium text-blue-600">{monthData.applied}</span>
                              </div>
                              <div className="flex justify-between">
                                <span>Response Rate:</span>
                                <span className="font-medium text-purple-600">{monthData.responseRate}%</span>
                              </div>
                              <div className="flex justify-between">
                                <span>Success Rate:</span>
                                <span className="font-medium text-amber-600">{monthData.successRate}%</span>
                              </div>
                              <div className="flex justify-between">
                                <span>Interviews:</span>
                                <span className="font-medium text-indigo-600">{monthData.interviews}</span>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                      <h3 className="font-semibold text-lg text-gray-800 mb-4">Status Distribution</h3>
                      <div style={{height: '280px'}}>
                        <ChartComponent chartId="chart2" type="bar" data={barData} options={{
                          indexAxis:'y', 
                          maintainAspectRatio: false, 
                          plugins:{
                            legend:{display:false},
                            tooltip: {
                              backgroundColor: 'rgba(0,0,0,0.8)',
                              titleColor: 'white',
                              bodyColor: 'white',
                              borderColor: 'rgba(0,0,0,0.1)',
                              borderWidth: 1
                            }
                          }, 
                          scales:{
                            x:{
                              beginAtZero:true, 
                              ticks: {stepSize: 1, color: '#6B7280', font: {size: 11}}, 
                              grid: {color: '#F3F4F6', lineWidth: 1},
                              border: {display: false}
                            }, 
                            y:{
                              ticks: {color: '#374151', font: {size: 11, weight: '500'}},
                              grid: {display: false},
                              border: {display: false}
                            }
                          },
                          elements: {bar: {borderRadius: 4}},
                          layout: {padding: {left: 10, right: 20}},
                          animation: {duration: 800, easing: 'easeInOutQuart'}
                        }} />
                      </div>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                    <Icon name="pie-chart" className="w-16 h-16 mx-auto text-gray-300" />
                    <p className="mt-4 text-xl font-semibold text-gray-600">No data to display</p>
                    <p className="text-sm text-gray-500 mt-1">Add your first application to see analytics</p>
                </div>
              )}
          </div>
        </div>
      );
    }
    
    function JobForm({ jobData, onSave, onCancel, existingJobs = [] }) {
        const [job, setJob] = React.useState(jobData);
        const [errors, setErrors] = React.useState({});
        
        // Extract unique companies and titles from existing jobs
        const companySuggestions = React.useMemo(() => {
            const companies = existingJobs
                .map(job => job.Company)
                .filter(company => company && company.trim())
                .filter((company, index, self) => self.indexOf(company) === index); // Remove duplicates
            return companies.sort();
        }, [existingJobs]);

        const titleSuggestions = React.useMemo(() => {
            const titles = existingJobs
                .map(job => job.Title)
                .filter(title => title && title.trim())
                .filter((title, index, self) => self.indexOf(title) === index); // Remove duplicates
            return titles.sort();
        }, [existingJobs]);

        const locationSuggestions = React.useMemo(() => {
            const locations = existingJobs
                .map(job => job.Location)
                .filter(location => location && location.trim())
                .filter((location, index, self) => self.indexOf(location) === index); // Remove duplicates
            return locations.sort();
        }, [existingJobs]);
        
        const handleChange = (field, value) => {
            setJob(prev => ({ ...prev, [field]: value }));
            // Clear error when user starts typing
            if (errors[field]) {
                setErrors(prev => ({ ...prev, [field]: false }));
            }
        };
        
        const validateForm = () => {
            const newErrors = {};
            if (!job.Company?.trim()) newErrors.Company = true;
            if (!job.Title?.trim()) newErrors.Title = true;
            if (!job.DateApplied?.trim()) newErrors.DateApplied = true;
            
            setErrors(newErrors);
            return Object.keys(newErrors).length === 0;
        };
        
        const handleSave = () => {
            if (!validateForm()) {
                showToast('Please fill in all required fields: Company, Job Title, and Date Applied', 'error');
                return;
            }
            onSave({ ...job, id: job.id || `job-${Date.now()}` });
        };
        
        return (
            <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label className="form-control w-full">
                        <div className="label">
                            <span className="label-text">Company <span className="text-red-500">*</span></span>
                        </div>
                        <AutocompleteInput
                            value={job.Company}
                            onChange={(value) => handleChange('Company', value)}
                            placeholder="e.g., Google"
                            suggestions={companySuggestions}
                            className={`input input-bordered w-full ${errors.Company ? 'input-error' : ''}`}
                        />
                        {errors.Company && <div className="label"><span className="label-text-alt text-red-500">Company is required</span></div>}
                    </label>
                    <label className="form-control w-full">
                        <div className="label">
                            <span className="label-text">Job Title <span className="text-red-500">*</span></span>
                        </div>
                        <AutocompleteInput
                            value={job.Title}
                            onChange={(value) => handleChange('Title', value)}
                            placeholder="e.g., Software Engineer"
                            suggestions={titleSuggestions}
                            className={`input input-bordered w-full ${errors.Title ? 'input-error' : ''}`}
                        />
                        {errors.Title && <div className="label"><span className="label-text-alt text-red-500">Job Title is required</span></div>}
                    </label>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label className="form-control w-full">
                        <div className="label"><span className="label-text">Status</span></div>
                        <select className="select select-bordered" value={job.Status} onChange={e => handleChange('Status', e.target.value)}>
                            {statusList.map(s => <option key={s}>{s}</option>)}
                        </select>
                    </label>
                    <label className="form-control w-full">
                        <div className="label"><span className="label-text">Job Type</span></div>
                        <select className="select select-bordered" value={job.JobType} onChange={e => handleChange('JobType', e.target.value)}>
                            {jobTypeList.map(t => <option key={t}>{t}</option>)}
                        </select>
                    </label>
                    <label className="form-control w-full">
                        <div className="label"><span className="label-text">Source</span></div>
                        <select className="select select-bordered" value={job.Source} onChange={e => handleChange('Source', e.target.value)}>
                            {sourceList.map(s => <option key={s}>{s}</option>)}
                        </select>
                    </label>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label className="form-control w-full">
                        <div className="label"><span className="label-text">Location</span></div>
                        <AutocompleteInput
                            value={job.Location}
                            onChange={(value) => handleChange('Location', value)}
                            placeholder="e.g., Milan, Italy"
                            suggestions={locationSuggestions}
                            className="input input-bordered w-full"
                        />
                    </label>
                    <label className="form-control w-full">
                        <div className="label">
                            <span className="label-text">Date Applied <span className="text-red-500">*</span></span>
                        </div>
                        <input 
                            type="date" 
                            className={`input input-bordered w-full ${errors.DateApplied ? 'input-error' : ''}`}
                            value={job.DateApplied} 
                            onChange={e => handleChange('DateApplied', e.target.value)} 
                        />
                        {errors.DateApplied && <div className="label"><span className="label-text-alt text-red-500">Date Applied is required</span></div>}
                    </label>
                </div>
                <label className="form-control w-full">
                    <div className="label"><span className="label-text">Next Step / Notes</span></div>
                    <input type="text" placeholder="e.g., Prepare for interview" className="input input-bordered w-full" value={job.NextStep} onChange={e => handleChange('NextStep', e.target.value)} />
                </label>
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-sm text-blue-700">
                        <span className="text-red-500">*</span> Required fields: Company, Job Title, and Date Applied must be filled to save the application.
                    </p>
                </div>
                <div className="modal-action">
                    <button className="btn" onClick={onCancel}>Cancel</button>
                    <button className="btn btn-primary" onClick={handleSave}>Save</button>
                </div>
            </div>
        );
    }
    
    function TrackerTable({ jobs, updateJobs, searchTerm }) {
      const [editingJob, setEditingJob] = React.useState(null);
      
      const startEditing = (job) => {
        setEditingJob({ ...job });
        document.getElementById('edit_job_modal').showModal();
      };
      
      const deleteJob = (id) => { 
        if(confirm('Are you sure you want to delete this application?')) {
          updateJobs(jobs.filter(j => j.id !== id));
          showToast('Application deleted!', 'info');
        }
      };

      const handleSaveEdit = (updatedJob) => {
        updateJobs(jobs.map(j => j.id === updatedJob.id ? updatedJob : j));
        document.getElementById('edit_job_modal').close();
        setEditingJob(null);
        showToast('Job updated successfully!', 'success');
      };
      
      return (
        <div className="p-6">
          {jobs.length === 0 ? (
              <div className="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                <Icon name="inbox" className="w-16 h-16 mx-auto text-gray-300" />
                <p className="mt-4 text-xl font-semibold text-gray-600">No applications yet</p>
                <p className="text-sm text-gray-500 mt-1">Click "New Application" to get started</p>
              </div>
          ) : (
              <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b border-gray-200">
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '12%'}}>Status</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '14%'}}>Company</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '18%'}}>Role</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '10%'}}>Location</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '8%'}}>Type</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '10%'}}>Source</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '10%'}}>Date Applied</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '12%'}}>Next Step</th>
                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width: '6%'}}>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {jobs.map((j) => {
                        return (
                          <tr key={j.id} className={`border-b border-gray-100 transition-colors duration-150 ${getStatusColorClass(j.Status)} hover:bg-opacity-80`}>
                            <td className="py-3 px-3">
                              <span className="text-sm font-medium">{j.Status}</span>
                            </td>
                            <td className="py-3 px-3">
                              <span className="text-sm font-medium">{j.Company}</span>
                            </td>
                            <td className="py-3 px-3">
                              <span className="text-sm">{j.Title}</span>
                            </td>
                            <td className="py-3 px-3">
                              <div className="flex items-center gap-1">
                                <span className="text-sm">{j.Location}</span>
                                {j.Location && (
                                  <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(j.Location)}`} target="_blank" rel="noopener noreferrer" 
                                      className="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition-colors duration-150">
                                      <Icon name="map-pin" className="w-3 h-3"/>
                                  </a>
                                )}
                              </div>
                            </td>
                            <td className="py-3 px-3">
                              <span className="text-xs">{j.JobType}</span>
                            </td>
                            <td className="py-3 px-3">
                              <span className="text-xs">{j.Source}</span>
                            </td>
                            <td className="py-3 px-3">
                              <span className="text-xs">{j.DateApplied || 'N/A'}</span>
                            </td>
                            <td className="py-3 px-3">
                              <Tooltip text={j.NextStep}>
                                <span className="text-xs truncate block max-w-24">{j.NextStep}</span>
                              </Tooltip>
                            </td>
                            <td className="py-3 px-3">
                              <div className="flex gap-1">
                                <button className="text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-1 rounded transition-colors duration-150" 
                                        onClick={() => startEditing(j)} title="Edit">
                                  <Icon name="edit-2" className="w-4 h-4" />
                                </button>
                                <button className="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition-colors duration-150" 
                                        onClick={() => deleteJob(j.id)} title="Delete">
                                  <Icon name="trash-2" className="w-4 h-4" />
                                </button>
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
          )}
          
          {/* Edit Job Modal */}
          {editingJob && (
            <Modal id="edit_job_modal" title="Edit Job Application">
              <JobForm 
                jobData={editingJob} 
                existingJobs={jobs}
                onSave={handleSaveEdit} 
                onCancel={() => {
                  document.getElementById('edit_job_modal').close();
                  setEditingJob(null);
                }} 
              />
            </Modal>
          )}
        </div>
      );
    }
    
    function ContactsTable({ contacts, setContacts, searchTerm }) {
        const updateContact = (id, field, value) => setContacts(contacts.map(c => c.id === id ? { ...c, [field]: value } : c));
        const deleteContact = (id) => { if(confirm('Are you sure?')) setContacts(contacts.filter(c => c.id !== id)); };
        const addContact = (contact) => { setContacts(prev => [...prev, contact]); document.getElementById('add_contact_modal').close(); setNewContact(emptyContact); };
        const [newContact, setNewContact] = React.useState(emptyContact);

        return (
            <div className="bg-white rounded-2xl shadow-xl border border-gray-100">
                <div className="p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-semibold text-gray-800">Networking</h2>
                        <button className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors duration-200" 
                                onClick={() => document.getElementById('add_contact_modal').showModal()}>
                            <Icon name="plus" className="w-4 h-4"/> Add Contact
                        </button>
                    </div>
                    {contacts.length === 0 ? (
                        <div className="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                            <Icon name="users" className="w-16 h-16 mx-auto text-gray-300" />
                            <p className="mt-4 text-xl font-semibold text-gray-600">No contacts yet</p>
                            <p className="text-sm text-gray-500 mt-1">Start building your professional network</p>
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-gray-200">
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'20%'}}>Name</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'20%'}}>Company</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'15%'}}>Role</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'15%'}}>Location</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'15%'}}>Contact Date</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm">Notes</th>
                                        <th className="text-left py-4 px-3 font-semibold text-gray-700 text-sm" style={{width:'5%'}}></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {contacts.map((c) => (
                                        <tr key={c.id} className="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Name} onChange={e => updateContact(c.id, 'Name', e.target.value)} placeholder="Name" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Company} onChange={e => updateContact(c.id, 'Company', e.target.value)} placeholder="Company" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Role} onChange={e => updateContact(c.id, 'Role', e.target.value)} placeholder="Role" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Location || ''} onChange={e => updateContact(c.id, 'Location', e.target.value)} placeholder="Location" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="date" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.ContactDate} onChange={e => updateContact(c.id, 'ContactDate', e.target.value)} />
                                            </td>
                                            <td className="py-3 px-3">
                                                <input type="text" className="w-full bg-transparent border-none text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-2" 
                                                       value={c.Notes} onChange={e => updateContact(c.id, 'Notes', e.target.value)} placeholder="Notes" />
                                            </td>
                                            <td className="py-3 px-3">
                                                <button className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors duration-150" 
                                                        onClick={()=>deleteContact(c.id)}>
                                                    <Icon name="trash-2" className="w-4 h-4"/>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
                <Modal id="add_contact_modal" title="Add New Contact">
                    <div className="space-y-4">
                        <input type="text" placeholder="Name" className="input input-bordered w-full" 
                               value={newContact.Name} onChange={e => setNewContact({...newContact, Name: e.target.value})} />
                        <input type="text" placeholder="Company" className="input input-bordered w-full" 
                               value={newContact.Company} onChange={e => setNewContact({...newContact, Company: e.target.value})} />
                        <input type="text" placeholder="Role" className="input input-bordered w-full" 
                               value={newContact.Role} onChange={e => setNewContact({...newContact, Role: e.target.value})} />
                        <input type="text" placeholder="Location" className="input input-bordered w-full"
                                value={newContact.Location} onChange={e => setNewContact({...newContact, Location: e.target.value})} />
                        <input type="date" className="input input-bordered w-full" 
                               value={newContact.ContactDate} onChange={e => setNewContact({...newContact, ContactDate: e.target.value})} />
                        <textarea className="textarea textarea-bordered w-full" placeholder="Notes" 
                                  value={newContact.Notes} onChange={e => setNewContact({...newContact, Notes: e.target.value})}></textarea>
                        <div className="modal-action">
                            <button type="button" className="btn" onClick={() => document.getElementById('add_contact_modal').close()}>Cancel</button>
                            <button type="button" className="btn btn-primary" onClick={() => addContact({...newContact, id: `contact-${Date.now()}`})}>Save</button>
                        </div>
                    </div>
                </Modal>
            </div>
        );
    }
    
    /********* Kanban Components *********/
    const KanbanComponents = {};

    KanbanComponents.KanbanCard = function({ job, onDragStart }) {
      return (
        <div 
          draggable
          onDragStart={(e) => onDragStart(e, job.id)}
          className="bg-white rounded-lg p-3 mb-2 shadow-sm border border-gray-200 cursor-grab active:cursor-grabbing"
        >
          <h4 className="font-bold text-sm text-gray-800">{job.Company}</h4>
          <p className="text-xs text-gray-600">{job.Title}</p>
          {job.Location && (
            <div className="text-xs mt-2 text-blue-600 font-medium">
              📍 {job.Location}
            </div>
          )}
        </div>
      );
    }

    KanbanComponents.KanbanColumn = function({ title, jobs, onDragOver, onDrop, onDragStart }) {
      return (
        <div 
          className="bg-gray-100 rounded-xl p-3 w-64 md:w-72 flex-shrink-0"
          onDragOver={onDragOver}
          onDrop={(e) => onDrop(e, title)}
        >
          <h3 className="font-semibold text-sm text-gray-700 mb-3 px-1">{title} ({jobs.length})</h3>
          <div className="space-y-2 min-h-[100px]">
            {jobs.map(job => <KanbanComponents.KanbanCard key={job.id} job={job} onDragStart={onDragStart} />)}
          </div>
        </div>
      );
    }

    KanbanComponents.KanbanBoard = function({ jobs, setJobs }) {
      const [showBoard, setShowBoard] = React.useState(false);

      const handleDragStart = (e, jobId) => {
        e.dataTransfer.setData("jobId", jobId);
      };

      const handleDragOver = (e) => {
        e.preventDefault();
      };

      const handleDrop = (e, targetStatus) => {
        const jobId = e.dataTransfer.getData("jobId");
        const updatedJobs = jobs.map(job => {
          if (job.id === jobId) {
            // If dropped on backlog, set status to "Wishlist". Otherwise, use the column's status.
            const newStatus = targetStatus === "Backlog" ? "Wishlist" : targetStatus;
            return { ...job, Status: newStatus };
          }
          return job;
        });
        setJobs(updatedJobs);
      };

      const boardJobs = jobs.filter(j => KANBAN_COLUMNS.slice(1).includes(j.Status));
      const backlogJobs = jobs.filter(j => !KANBAN_COLUMNS.slice(1).includes(j.Status));

      return (
        <div className="bg-white rounded-2xl shadow-xl border border-gray-100">
          <div className="p-6 cursor-pointer hover:bg-gray-50 transition-colors duration-150" onClick={() => setShowBoard(!showBoard)}>
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <Icon name="trello" className="w-6 h-6 text-blue-500"/>
                <h2 className="text-xl font-semibold text-gray-800">Kanban View</h2>
              </div>
              <Icon name={showBoard ? "chevron-up" : "chevron-down"} className="w-6 h-6" />
            </div>
          </div>
          {showBoard && (
            <div className="px-6 pb-6 pt-2 overflow-x-auto">
              <div className="flex space-x-4">
                <KanbanComponents.KanbanColumn 
                    title="Backlog" 
                    jobs={backlogJobs} 
                    onDragOver={handleDragOver} 
                    onDrop={handleDrop} 
                    onDragStart={handleDragStart} 
                />
                {KANBAN_COLUMNS.slice(1).map(status => (
                  <KanbanComponents.KanbanColumn
                    key={status}
                    title={status}
                    jobs={boardJobs.filter(job => job.Status === status)}
                    onDragOver={handleDragOver}
                    onDrop={handleDrop}
                    onDragStart={handleDragStart}
                  />
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }

    function EmailTemplatesModal({ jobData, onCancel }) {
        const [activeTemplate, setActiveTemplate] = React.useState('followUp');
        const company = jobData?.Company || "[Company Name]";
        const title = jobData?.Title || "[Job Title]";
        const templates = {
            followUp: {
                name: "Follow-Up After Application",
                subject: `Following Up on My Application for the ${title} Position`,
                body: `Dear Hiring Manager,\n\nI hope this email finds you well.\n\nI am writing to follow up on my application for the ${title} position at ${company}. I submitted my application on [Date of Application] and I am very interested in this opportunity.\n\nI am confident that my skills in [mention 1-2 key skills] and my experience with [mention relevant experience] make me a strong candidate for this role. I am particularly excited about [mention something specific about the company or role].\n\nCould you please provide an update on the status of my application? I am available for an interview at your earliest convenience.\n\nThank you for your time and consideration.\n\nSincerely,\n[Your Name]`
            },
            thankYou: {
                name: "Thank You After Interview",
                subject: `Thank You - Interview for ${title} at ${company}`,
                body: `Dear [Interviewer's Name],\n\nThank you so much for taking the time to speak with me today about the ${title} position at ${company}.\n\nI enjoyed our conversation and learning more about [mention something specific you discussed]. Our discussion confirmed my interest in this role and my enthusiasm to join your team. I was particularly interested in [mention another specific point].\n\nI am very excited about the opportunity to contribute my skills in [mention skills] to your team. Please let me know if there is any other information I can provide.\n\nI look forward to hearing from you soon.\n\nBest regards,\n[Your Name]`
            },
            networking: {
                name: "Networking Follow-Up",
                subject: `Following Up: ${title} at ${company}`,
                body: `Dear [Contact's Name],\n\nIt was a pleasure speaking with you at [Event or Occasion where you met]. I really enjoyed our conversation about [mention topic you discussed].\n\nAs we discussed, I am very interested in the ${title} role at ${company}. I have attached my resume for your consideration. I believe my background in [mention your experience] aligns well with the requirements of this position.\n\nThank you again for your time and advice. I hope to stay in touch.\n\nBest,\n[Your Name]`
            }
        };

        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }, (err) => {
                showToast('Failed to copy.', 'error');
            });
        };

        const currentTemplate = templates[activeTemplate];

        return (
            <dialog id="email_templates_modal" className="modal">
                <div className="modal-box w-11/12 max-w-4xl">
                    <form method="dialog"><button className="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onClick={onCancel}>✕</button></form>
                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="mail" className="w-5 h-5"/> Email Templates</h3>
                    <div className="flex gap-6">
                        <div className="w-1/3">
                            <ul className="menu bg-base-200 rounded-box">
                                {Object.keys(templates).map(key => (
                                    <li key={key}><a className={activeTemplate === key ? 'active' : ''} onClick={() => setActiveTemplate(key)}>{templates[key].name}</a></li>
                                ))}
                            </ul>
                        </div>
                        <div className="w-2/3">
                            <div className="form-control">
                                <label className="label"><span className="label-text">Subject</span></label>
                                <div className="join">
                                    <input type="text" readOnly className="input input-bordered w-full join-item" value={currentTemplate.subject} />
                                    <button className="btn join-item" onClick={() => copyToClipboard(currentTemplate.subject)}><Icon name="copy" className="w-4 h-4" /></button>
                                </div>
                            </div>
                            <div className="form-control mt-4">
                                <label className="label"><span className="label-text">Body</span></label>
                                <div className="join">
                                    <textarea readOnly className="textarea textarea-bordered w-full h-64 join-item" value={currentTemplate.body}></textarea>
                                    <button className="btn join-item" onClick={() => copyToClipboard(currentTemplate.body)}><Icon name="copy" className="w-4 h-4" /></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="modal-action">
                        <button className="btn" onClick={onCancel}>Close</button>
                    </div>
                </div>
                <form method="dialog" className="modal-backdrop"><button onClick={onCancel}>close</button></form>
            </dialog>
        );
    }

    function App() {
      const { user, loading: authLoading, signOut } = useAuth();
      const { jobs, contacts, loading: dataLoading, updateJobs, updateContacts, loadUserData } = useFirebaseData(user);
      const [jobSearchTerm, setJobSearchTerm] = React.useState('');
      const [contactSearchTerm, setContactSearchTerm] = React.useState('');
      const [statusFilters, setStatusFilters] = React.useState([]);
      const [jobTypeFilters, setJobTypeFilters] = React.useState([]);
      const [sourceFilters, setSourceFilters] = React.useState([]);
      const [locationFilter, setLocationFilter] = React.useState('');
      const [selectedMetricFilters, setSelectedMetricFilters] = React.useState([]);
      const [newJob, setNewJob] = React.useState(emptyJob);
      const [selectedJobForEmail, setSelectedJobForEmail] = React.useState(null);

      const jobsForAnalytics = React.useMemo(() => {
        return jobs
          .filter(job => statusFilters.length === 0 || statusFilters.includes(job.Status))
          .filter(job => jobTypeFilters.length === 0 || jobTypeFilters.includes(job.JobType))
          .filter(job => sourceFilters.length === 0 || sourceFilters.includes(job.Source))
          .filter(job => locationFilter === '' || job.Location.toLowerCase().includes(locationFilter.toLowerCase()))
          .filter(job => jobSearchTerm === '' || 
            job.Company.toLowerCase().includes(jobSearchTerm.toLowerCase()) || 
            job.Title.toLowerCase().includes(jobSearchTerm.toLowerCase()) ||
            job.NextStep.toLowerCase().includes(jobSearchTerm.toLowerCase())
          );
      }, [jobs, statusFilters, jobTypeFilters, sourceFilters, locationFilter, jobSearchTerm]);

      const filteredJobs = React.useMemo(() => {
        if (selectedMetricFilters.length === 0) {
          return jobsForAnalytics;
        }

        return jobsForAnalytics.filter(job => {
          return selectedMetricFilters.some(filter => {
            switch(filter) {
              case 'offers':
                return ["Offer Received", "Offer Accepted"].includes(job.Status);
              case 'rejected':
                return job.Status === "Rejected";
              case 'inProgress':
                return ["Applied", "HR Screening", "Technical Interview", "Case Study / Assessment", "Final Interview"].includes(job.Status);
              case 'total':
                return true; 
              default:
                return false;
            }
          });
        });
      }, [jobsForAnalytics, selectedMetricFilters]);

      const filteredContacts = React.useMemo(() => {
        return contacts.filter(contact => 
          contactSearchTerm === '' || 
          contact.Name.toLowerCase().includes(contactSearchTerm.toLowerCase()) || 
          contact.Company.toLowerCase().includes(contactSearchTerm.toLowerCase()) ||
          contact.Role.toLowerCase().includes(contactSearchTerm.toLowerCase())
        );
      }, [contacts, contactSearchTerm]);

      const handleSaveNewJob = (job) => {
        updateJobs(prev => [job, ...prev]);
        document.getElementById('add_job_modal').close();
        setNewJob(emptyJob);
        showToast('Application added!');
      };

      const clearAllFilters = () => {
        setSelectedMetricFilters([]);
        setStatusFilters([]);
        setJobTypeFilters([]);
        setSourceFilters([]);
        setLocationFilter('');
        setJobSearchTerm('');
        // Clear the search input field manually
        const searchInput = document.querySelector('input[placeholder="Search by company, title, or notes..."]');
        if (searchInput) searchInput.value = '';
      };
      
      const openEmailModal = (job) => {
        setSelectedJobForEmail(job);
        document.getElementById('email_templates_modal').showModal();
      };

      // Show loading screen while authenticating
      if (authLoading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-center">
              <div className="bg-blue-500 p-4 rounded-2xl w-16 h-16 mx-auto mb-4 animate-pulse">
                <Icon name="briefcase" className="w-8 h-8 text-white"/>
              </div>
              <div className="text-xl font-semibold text-gray-700">Loading CareerFlow...</div>
            </div>
          </div>
        );
      }

      // Show auth screen if not logged in
      if (!user) {
        return <AuthScreen />;
      }

      const handleMetricFilterToggle = (filterType) => {
        if (filterType === 'total') {
            clearAllFilters();
            return;
        }
        setSelectedMetricFilters(prev => {
          if (prev.includes(filterType)) {
            return prev.filter(f => f !== filterType);
          } else {
            return [...prev, filterType];
          }
        });
      };

      const handleDataAction = (action) => {
        if (action === 'export') { 
          const data = { jobs, contacts, exportDate: new Date().toISOString() };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `job-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          showToast('Data exported successfully!', 'success');
        }
        else if (action === 'download_template') {
          const templateData = {
            "_instructions": {
              "description": "CareerFlow Import Template",
              "version": "1.0",
              "instructions": [
                "This is a template file showing the correct format for importing data into CareerFlow.",
                "Replace the sample data below with your actual job applications and contacts.",
                "All fields are optional except for Company, Title, and DateApplied for jobs.",
                "Status must be one of: Wishlist, Applied, HR Screening, Technical Interview, Case Study / Assessment, Final Interview, Offer Received, Offer Accepted, Rejected, Withdrawn",
                "JobType must be one of: Internship, Full-Time, Part-Time, Thesis Project",
                "Source must be one of: Polimi CareerService, LinkedIn, Company Website, Referral, Networking Event, Other",
                "Dates should be in YYYY-MM-DD format",
                "After editing, save this file and use the 'Import Data' feature in CareerFlow"
              ]
            },
            "jobs": [
              {
                "id": "job-template-1",
                "Status": "Applied",
                "Company": "Example Company Ltd",
                "Title": "Software Engineer Intern", 
                "JobType": "Internship",
                "Location": "Milan, Italy",
                "Source": "LinkedIn",
                "AppDeadline": "2025-12-31",
                "DateApplied": "2025-01-15",
                "NextStep": "Waiting for HR screening call"
              },
              {
                "id": "job-template-2", 
                "Status": "HR Screening",
                "Company": "Tech Startup Inc",
                "Title": "Product Manager",
                "JobType": "Full-Time",
                "Location": "Remote",
                "Source": "Company Website",
                "AppDeadline": "2025-11-30",
                "DateApplied": "2025-01-10",
                "NextStep": "Completed initial call, technical interview scheduled"
              },
              {
                "id": "job-template-3",
                "Status": "Wishlist", 
                "Company": "Dream Company",
                "Title": "Data Scientist",
                "JobType": "Full-Time",
                "Location": "London, UK",
                "Source": "Referral",
                "AppDeadline": "",
                "DateApplied": "",
                "NextStep": "Need to improve Python skills before applying"
              }
            ],
            "contacts": [
              {
                "id": "contact-template-1",
                "Name": "John Smith",
                "Company": "Example Company Ltd",
                "Role": "Senior HR Manager",
                "Location": "Milan, Italy",
                "ContactDate": "2025-01-12",
                "Notes": "Met at university career fair. Very helpful with application process tips."
              },
              {
                "id": "contact-template-2",
                "Name": "Sarah Johnson", 
                "Company": "Tech Startup Inc",
                "Role": "Engineering Manager",
                "Location": "Remote",
                "ContactDate": "2025-01-08",
                "Notes": "LinkedIn connection. Provided insights about company culture and tech stack."
              }
            ],
            "exportDate": new Date().toISOString()
          };
          
          const blob = new Blob([JSON.stringify(templateData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'careerflow-import-template.json';
          a.click();
          URL.revokeObjectURL(url);
          showToast('Import template downloaded! Edit the file and use Import Data to upload it.', 'success');
        } 
        else if (action === 'import') { 
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                try {
                  const data = JSON.parse(e.target.result);
                  let importedJobs = 0;
                  let importedContacts = 0;
                  
                  if (data.jobs && Array.isArray(data.jobs)) {
                    // Filter out template examples and instructions
                    const realJobs = data.jobs.filter(job => !job.id.includes('template'));
                    if (realJobs.length > 0) {
                      updateJobs(realJobs);
                      importedJobs = realJobs.length;
                    }
                  }
                  if (data.contacts && Array.isArray(data.contacts)) {
                    // Filter out template examples
                    const realContacts = data.contacts.filter(contact => !contact.id.includes('template'));
                    if (realContacts.length > 0) {
                      updateContacts(realContacts);
                      importedContacts = realContacts.length;
                    }
                  }
                  
                  if (importedJobs > 0 || importedContacts > 0) {
                    showToast(`Successfully imported ${importedJobs} job applications and ${importedContacts} contacts!`, 'success');
                  } else {
                    showToast('No valid data found to import. Make sure to replace template examples with your actual data.', 'info');
                  }
                } catch (error) {
                  console.error('Import error:', error);
                  showToast('Error importing data. Please check the file format and try again.', 'error');
                }
              };
              reader.readAsText(file);
            }
          };
          input.click();
        }
        else if (action === 'migrate_local') {
          const localJobs = localStorage.getItem('job-tracker-jobs-v4');
          const localContacts = localStorage.getItem('job-tracker-contacts-v4');
          
          if (localJobs || localContacts) {
            if (confirm('This will migrate your local data to Firebase. Your existing Firebase data will be replaced. Continue?')) {
              try {
                if (localJobs) {
                  const jobs = JSON.parse(localJobs);
                  updateJobs(jobs);
                  showToast(`Migrated ${jobs.length} job applications to Firebase!`, 'success');
                }
                if (localContacts) {
                  const contacts = JSON.parse(localContacts);
                  updateContacts(contacts);
                  showToast(`Migrated ${contacts.length} contacts to Firebase!`, 'success');
                }
                // Clear local storage after successful migration
                localStorage.removeItem('job-tracker-jobs-v4');
                localStorage.removeItem('job-tracker-contacts-v4');
                showToast('Local data migration completed!', 'success');
              } catch (error) {
                showToast('Error migrating local data.', 'error');
              }
            }
          } else {
            showToast('No local data found to migrate.', 'info');
          }
        }
        else if (action === 'restore_dummy') {
            if (confirm('Bu işlem mevcut tüm veriyi silip örnek verileri yükleyecek. Emin misiniz?')) {
                updateJobs(sampleJobs);
                updateContacts(sampleContacts);
                showToast('Örnek veriler başarıyla yüklendi!', 'success');
            }
        }
        else if (action === 'reset') {
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
                updateJobs([]);
                updateContacts([]);
                showToast('All data has been cleared.', 'info');
            }
        }
      };

      const StatusDropdownFilter = ({ selectedOptions, setSelectedOptions }) => {
        const handleToggle = (option) => {
            setSelectedOptions(prev => 
                prev.includes(option) ? prev.filter(item => item !== option) : [...prev, option]
            );
        };

        return (
            <div>
                <label className="block text-xs font-medium text-gray-700 mb-2">Status Filter</label>
                <div className="space-y-2 max-h-48 overflow-y-auto bg-white border border-gray-200 rounded-lg p-3">
                    {statusList.map(option => (
                        <label key={option} className="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-1 rounded">
                            <input 
                                type="checkbox" 
                                checked={selectedOptions.includes(option)} 
                                onChange={() => handleToggle(option)}
                                className="checkbox checkbox-primary checkbox-sm"
                            />
                            <span className="text-sm text-gray-700">{option}</span>
                        </label>
                    ))}
                </div>
                {selectedOptions.length > 0 && (
                    <div className="mt-2 text-xs text-gray-500">
                        {selectedOptions.length} status{selectedOptions.length !== 1 ? 'es' : ''} selected
                    </div>
                )}
            </div>
        );
      };

      return (
        <div className="space-y-8 bg-gray-50 min-h-screen">
            <div className="bg-white shadow-lg border-b border-gray-200 sticky top-0 z-10">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex justify-between items-center py-4">
                  <div className="flex items-center gap-3">
                    <div className="bg-blue-500 p-2 rounded-lg">
                      <Icon name="briefcase" className="w-6 h-6 text-white"/>
                    </div>
                    <h1 className="text-2xl font-bold text-gray-900">CareerFlow</h1>
                  </div>
                  <div className="flex items-center gap-3">
                    {dataLoading && (
                      <div className="flex items-center gap-2 text-sm text-gray-600">
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
                        Syncing...
                      </div>
                    )}
                    <div className="dropdown dropdown-end">
                      <div tabIndex={0} role="button" className="btn btn-ghost btn-circle hover:bg-gray-100">
                        <Icon name="settings" className="w-5 h-5"/>
                      </div>
                      <ul tabIndex={0} className="menu menu-sm dropdown-content mt-3 z-[10] p-2 shadow-lg bg-white rounded-xl border border-gray-200 w-56">
                        <li><a onClick={() => handleDataAction('export')} className="text-blue-600 hover:bg-blue-50"><Icon name="download" className="w-4 h-4"/> Export Data</a></li>
                        <li><a onClick={() => handleDataAction('download_template')} className="text-indigo-600 hover:bg-indigo-50"><Icon name="file-text" className="w-4 h-4"/> Download Import Template</a></li>
                        <li><a onClick={() => handleDataAction('import')} className="text-green-600 hover:bg-green-50"><Icon name="upload" className="w-4 h-4"/> Import Data</a></li>
                        <li className="disabled"><a><Icon name="upload-cloud" className="w-4 h-4"/> Export to Google Drive <span className="text-xs badge badge-ghost">Coming Soon</span></a></li>
                        <li><hr className="my-1"/></li>
                        <li><a onClick={() => document.getElementById('email_templates_modal').showModal()}><Icon name="mail" className="w-4 h-4"/> Email Templates</a></li>
                        <li><a onClick={() => handleDataAction('restore_dummy')} className="text-purple-600 hover:bg-purple-50"><Icon name="refresh-cw" className="w-4 h-4"/> Restore Demo Data</a></li>
                        <li><hr className="my-1"/></li>
                        <li><a onClick={() => handleDataAction('reset')} className="text-red-600 hover:bg-red-50"><Icon name="trash" className="w-4 h-4"/> Reset All Data</a></li>
                      </ul>
                    </div>
                    <UserProfile user={user} onSignOut={signOut} />
                  </div>
                </div>
              </div>
            </div>

            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
              <Analytics jobs={jobsForAnalytics} selectedMetricFilters={selectedMetricFilters} onMetricFilterToggle={handleMetricFilterToggle} />
              
              <KanbanComponents.KanbanBoard jobs={jobs} setJobs={updateJobs} />

              <div className="space-y-6">
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                  <div className="flex justify-between items-center mb-4">
                      <h2 className="text-2xl font-bold text-gray-900">Job Applications</h2>
                      <button className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors duration-200" 
                              onClick={() => document.getElementById('add_job_modal').showModal()}>
                          <Icon name="plus" className="w-5 h-5"/> New Application
                      </button>
                  </div>
                  
                  <div className="space-y-4">
                    <div className="flex flex-wrap items-center gap-4">
                      <input type="text" placeholder="Search by company, title, or notes..." 
                             className="flex-1 min-w-64 px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                             onChange={e => setJobSearchTerm(e.target.value)} />
                      <button 
                        className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg border border-red-200 text-sm flex items-center gap-2 transition-colors duration-200"
                        onClick={clearAllFilters}
                      >
                        <Icon name="x-circle" className="w-4 h-4"/>
                        Clear All Filters
                      </button>
                    </div>
                    
                    {/* Always Visible Filters */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                      <div>
                        <StatusDropdownFilter selectedOptions={statusFilters} setSelectedOptions={setStatusFilters} />
                      </div>
                      <div>
                        <label className="block text-xs font-medium text-gray-700 mb-2">Job Type Filter</label>
                        <div className="space-y-2 max-h-48 overflow-y-auto bg-white border border-gray-200 rounded-lg p-3">
                          {jobTypeList.map(option => (
                            <label key={option} className="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-1 rounded">
                              <input 
                                type="checkbox" 
                                checked={jobTypeFilters.includes(option)} 
                                onChange={() => {
                                  setJobTypeFilters(prev => 
                                    prev.includes(option) ? prev.filter(item => item !== option) : [...prev, option]
                                  );
                                }}
                                className="checkbox checkbox-primary checkbox-sm"
                              />
                              <span className="text-sm text-gray-700">{option}</span>
                            </label>
                          ))}
                        </div>
                        {jobTypeFilters.length > 0 && (
                          <div className="mt-2 text-xs text-gray-500">
                            {jobTypeFilters.length} type{jobTypeFilters.length !== 1 ? 's' : ''} selected
                          </div>
                        )}
                      </div>
                      <div>
                        <label className="block text-xs font-medium text-gray-700 mb-2">Source Filter</label>
                        <div className="space-y-2 max-h-48 overflow-y-auto bg-white border border-gray-200 rounded-lg p-3">
                          {sourceList.map(option => (
                            <label key={option} className="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-1 rounded">
                              <input 
                                type="checkbox" 
                                checked={sourceFilters.includes(option)} 
                                onChange={() => {
                                  setSourceFilters(prev => 
                                    prev.includes(option) ? prev.filter(item => item !== option) : [...prev, option]
                                  );
                                }}
                                className="checkbox checkbox-primary checkbox-sm"
                              />
                              <span className="text-sm text-gray-700">{option}</span>
                            </label>
                          ))}
                        </div>
                        {sourceFilters.length > 0 && (
                          <div className="mt-2 text-xs text-gray-500">
                            {sourceFilters.length} source{sourceFilters.length !== 1 ? 's' : ''} selected
                          </div>
                        )}
                      </div>
                      <div>
                        <label className="block text-xs font-medium text-gray-700 mb-2">Location Filter</label>
                        <input type="text" placeholder="Filter by location..." 
                               className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
                               value={locationFilter} onChange={e => setLocationFilter(e.target.value)} />
                      </div>
                    </div>
                  </div>
                </div>
                
                <div className="bg-white rounded-xl shadow-sm border border-gray-100">
                  <div className="p-4 border-b border-gray-100">
                    <div className="flex items-center justify-between">
                      <div className="text-sm text-gray-600">
                        Showing {filteredJobs.length} of {jobs.length} applications
                      </div>
                      {filteredJobs.length !== jobs.length && (
                        <div className="text-xs text-blue-600">
                          {jobs.length - filteredJobs.length} applications filtered out
                        </div>
                      )}
                    </div>
                  </div>
                  <TrackerTable jobs={filteredJobs} updateJobs={updateJobs} />
                </div>
                
                <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                  <div className="flex justify-between items-center mb-4">
                      <h2 className="text-2xl font-bold text-gray-900">Networking</h2>
                      <input type="text" placeholder="Search contacts by name, company, or role..." 
                             className="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-80" 
                             onChange={e => setContactSearchTerm(e.target.value)} />
                  </div>
                  {filteredContacts.length !== contacts.length && (
                    <div className="mb-4 text-sm text-gray-600">
                      Showing {filteredContacts.length} of {contacts.length} contacts
                    </div>
                  )}
                                     <ContactsTable contacts={filteredContacts} setContacts={updateContacts} />
                </div>
              </div>
            </div>
            
            <Modal id="add_job_modal" title="Add New Job Application">
              <JobForm jobData={newJob} existingJobs={jobs} onSave={handleSaveNewJob} onCancel={() => document.getElementById('add_job_modal').close()} />
            </Modal>

            <EmailTemplatesModal jobData={selectedJobForEmail} onCancel={() => setSelectedJobForEmail(null)} />
        </div>
      );
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>